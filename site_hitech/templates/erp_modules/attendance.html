{% extends "dashboard/dashboard_base.html" %}
{% load static %}

{% block title %}Chấm công - Dashboard{% endblock %}

{% block page_title %}
<i class="fas fa-calendar-check text-primary me-2"></i>Chấm công
{% endblock %}

{% block extra_css %}
<style>
    .attendance-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .form-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        border: 2px dashed #dee2e6;
        margin-bottom: 20px;
    }
    
    .action-btn {
        padding: 12px 25px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 5px;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .stats-box {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    
    .work-badge {
        font-size: 0.9rem;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .method-badge {
        font-size: 0.8rem;
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: 500;
    }
    
    .hidden { display: none; }
    .show { display: block; }
    
    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Top Actions -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <!-- Chấm công hôm nay -->
            <div class="card">
                <div class="card-body">
                    <div class="attendance-card text-center">
                        <h5 class="mb-3">
                            <i class="fas fa-calendar-day me-2"></i>
                            Chấm công hôm nay: {{ "now"|date:"d/m/Y" }}
                        </h5>
                        <div id="todayAttendanceForm">
                            <!-- Nút sẽ render động bằng JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Quick Export -->
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="mb-3">
                        <i class="fas fa-file-excel text-success me-2"></i>
                        Xuất báo cáo
                    </h5>
                    <button class="btn btn-success action-btn w-100" onclick="exportMonthlyReport()" id="exportBtn">
                        <i class="fas fa-download me-2"></i>Xuất báo cáo Excel <span id="currentMonth"></span>
                                </button>
                </div>
                            </div>
                        </div>
                    </div>

    <!-- Attendance Form (Hidden) -->
    <div class="row mb-4 hidden" id="attendanceFormSection">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="formTitle">
                        <i class="fas fa-edit text-primary me-2"></i>
                        Chấm công
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-section">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Ngày chấm công</label>
                                <input type="date" class="form-control" id="attendanceDate" value="{{ "now"|date:"Y-m-d" }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Loại công việc</label>
                                <select class="form-select" id="workType" onchange="toggleConstructionFields()">
                                    <option value="">-- Chọn loại --</option>
                                    <option value="office">Văn phòng</option>
                                    <option value="construction">Đi công trình</option>
                                    <option value="off">Nghỉ</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="constructionFields" style="display: none;">
                                <div class="row">
                                    <div class="col-6">
                                    <label class="form-label">Tên công trình/Khách hàng</label>
                                        <input type="text" class="form-control" id="constructionName" placeholder="VD: HEINEKEN, PetroVietnam...">
                                </div>
                                    <div class="col-6">
                                    <label class="form-label">Phương pháp NDT</label>
                                    <select class="form-select" id="ndtMethod">
                                        <option value="">-- Chọn phương pháp --</option>
                                        <option value="UT">UT (Siêu âm)</option>
                                        <option value="MT">MT (Từ tính)</option>
                                        <option value="PT">PT (Thẩm thấu)</option>
                                        <option value="RT">RT (X-quang)</option>
                                        <option value="VT">VT (Mục thi)</option>
                                        <option value="ET">ET (Dòng xoáy)</option>
                                        <option value="multiple">Nhiều phương pháp</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                        <!-- Optional fields -->
                        <div class="row g-3 mt-3">
                            <div class="col-md-3">
                                <label class="form-label">Tăng ca đến (nếu có)</label>
                                <input type="time" class="form-control" id="overtimeUntil">
                        </div>
                            <div class="col-md-3">
                                <label class="form-label">Chi phí (VNĐ)</label>
                                <input type="number" class="form-control" id="expenseAmount" placeholder="0">
                    </div>
                            <div class="col-md-6">
                                <label class="form-label">Ghi chú</label>
                                <input type="text" class="form-control" id="workNote" placeholder="Mô tả công việc...">
            </div>
        </div>
        
                        <div class="text-end mt-3">
                            <button class="btn btn-secondary me-2" onclick="hideAttendanceForm()">
                                <i class="fas fa-times me-2"></i>Hủy
                            </button>
                            <button class="btn btn-primary" onclick="saveAttendance()">
                                <i class="fas fa-save me-2"></i>Lưu chấm công
                            </button>
                    </div>
                            </div>
                        </div>
                            </div>
                        </div>
                            </div>
    
    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section">
                <div class="row align-items-end g-3">
                    <div class="col-md-2">
                        <label class="form-label">Tháng/Năm</label>
                        <input type="month" class="form-control" id="filterMonth" value="{{ "now"|date:"Y-m" }}" onchange="loadAttendanceData()">
                        </div>
                    <div class="col-md-2">
                        <label class="form-label">Loại công việc</label>
                        <select class="form-select" id="filterWorkType" onchange="loadAttendanceData()">
                            <option value="">Tất cả</option>
                            <option value="office">Văn phòng</option>
                            <option value="construction">Công trình</option>
                            <option value="off">Nghỉ</option>
                        </select>
                            </div>
                    <div class="col-md-2">
                        <label class="form-label">Phương pháp NDT</label>
                        <select class="form-select" id="filterNDTMethod" onchange="loadAttendanceData()">
                            <option value="">Tất cả</option>
                            <option value="UT">UT</option>
                            <option value="MT">MT</option>
                            <option value="PT">PT</option>
                            <option value="RT">RT</option>
                            <option value="VT">VT</option>
                            <option value="ET">ET</option>
                        </select>
                        </div>
                    <div class="col-md-3">
                        <label class="form-label">Tìm kiếm</label>
                        <input type="text" class="form-control" id="searchKeyword" placeholder="Tên công trình, ghi chú..." onkeyup="loadAttendanceData()">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="loadAttendanceData()">
                            <i class="fas fa-search me-2"></i>Lọc
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="clearFilter()">
                            <i class="fas fa-eraser me-2"></i>Xóa lọc
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-box">
                <h4 class="text-primary mb-1" id="totalWorkDays">0</h4>
                <small class="text-muted">Ngày đi làm</small>
                </div>
                    </div>
        <div class="col-md-3">
            <div class="stats-box">
                <h4 class="text-success mb-1" id="constructionDays">0</h4>
                <small>Công trình</small>
                </div>
        </div>
        <div class="col-md-3">
            <div class="stats-box">
                <h4 class="text-info mb-1" id="officeDays">0</h4>
                <small>Văn phòng</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-box">
                <h4 class="text-warning mb-1" id="overtimeDays">0</h4>
                <small>Ngày tăng ca</small>
            </div>
        </div>
    </div>
    
    <!-- Attendance Data -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table text-primary me-2"></i>
                        Dữ liệu chấm công <span id="currentMonthDisplay"></span>
                    </h5>
                    <div>
                        <button class="btn btn-outline-success btn-sm" onclick="exportCurrentView()">
                            <i class="fas fa-file-excel me-1"></i>
                            Xuất dữ liệu hiện tại
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Ngày</th>
                                    <th>Loại công việc</th>
                                    <th>Công trình/Mô tả</th>
                                    <th>Phương pháp NDT</th>
                                    <th>Tăng ca</th>
                                    <th>Chi phí</th>
                                    <th>Ghi chú</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-2 d-block"></i>
                                        Đang tải dữ liệu...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// Global data
let attendanceData = [];
let currentMode = 'today'; // 'today' or 'makeup'

// Show attendance form
function showAttendanceForm(mode) {
    currentMode = mode;
    const formSection = document.getElementById('attendanceFormSection');
    const formTitle = document.getElementById('formTitle');
    const dateInput = document.getElementById('attendanceDate');
    
    if (mode === 'today') {
        formTitle.innerHTML = '<i class="fas fa-edit text-primary me-2"></i>Chấm công hôm nay';
        dateInput.value = new Date().toISOString().split('T')[0];
        dateInput.disabled = true;
    } else {
        formTitle.innerHTML = '<i class="fas fa-calendar-plus text-warning me-2"></i>Chấm công bù';
        dateInput.disabled = false;
    }
    
    formSection.classList.remove('hidden');
    formSection.classList.add('show');
}

function showMakeupForm() {
    showAttendanceForm('makeup');
}

function hideAttendanceForm() {
    document.getElementById('attendanceFormSection').classList.add('hidden');
    document.getElementById('attendanceFormSection').classList.remove('show');
    clearForm();
}

function clearForm() {
    document.getElementById('workType').value = '';
    document.getElementById('constructionName').value = '';
    document.getElementById('ndtMethod').value = '';
    document.getElementById('overtimeUntil').value = '';
    document.getElementById('expenseAmount').value = '';
    document.getElementById('workNote').value = '';
    document.getElementById('constructionFields').style.display = 'none';
}

function toggleConstructionFields() {
    const workType = document.getElementById('workType').value;
    const constructionFields = document.getElementById('constructionFields');
    
    if (workType === 'construction') {
        constructionFields.style.display = 'block';
    } else {
        constructionFields.style.display = 'none';
    }
}

function renderTodayAttendanceButton() {
    const today = new Date().toISOString().slice(0, 10);
    const data = JSON.parse(localStorage.getItem('attendanceData') || '[]');
    const todayRecord = data.find(r => r.date === today);
    let html = '';
    if (todayRecord) {
        html += `<button class="btn btn-secondary action-btn" disabled style="opacity:0.8;cursor:not-allowed;">
            <i class="fas fa-check-double me-2"></i>Đã chấm công hôm nay
        </button>`;
    } else {
        html += `<button class="btn btn-success action-btn" onclick="showAttendanceForm('today')">
            <i class="fas fa-check me-2"></i>Chấm công hôm nay
        </button>`;
    }
    html += `<button class="btn btn-warning action-btn" onclick="showMakeupForm()">
        <i class="fas fa-calendar-plus me-2"></i>Chấm công bù
    </button>`;
    document.getElementById('todayAttendanceForm').innerHTML = html;
}

function saveAttendance() {
    const date = document.getElementById('attendanceDate').value;
    const workType = document.getElementById('workType').value;
        const constructionName = document.getElementById('constructionName').value;
        const ndtMethod = document.getElementById('ndtMethod').value;
    const overtimeUntil = document.getElementById('overtimeUntil').value;
    const expenseAmount = document.getElementById('expenseAmount').value;
    const workNote = document.getElementById('workNote').value;
        
    if (!date || !workType) {
        Swal.fire('Lỗi', 'Vui lòng nhập đầy đủ ngày và loại công việc!', 'error');
            return;
        }
    
    if (workType === 'construction' && (!constructionName || !ndtMethod)) {
        Swal.fire('Lỗi', 'Vui lòng nhập tên công trình và phương pháp NDT!', 'error');
            return;
        }
        
    // Create attendance record
    const record = {
        date: date,
        workType: workType,
        constructionName: constructionName || '',
        ndtMethod: ndtMethod || '',
        overtimeUntil: overtimeUntil || '',
        expenseAmount: expenseAmount || '',
        workNote: workNote || '',
        timestamp: new Date().toISOString()
    };
    
    // Save to localStorage (in real app, this would be sent to server)
    let existingData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
    
    // Remove existing record for same date if exists
    existingData = existingData.filter(item => item.date !== date);
    
    // Add new record
    existingData.push(record);
    localStorage.setItem('attendanceData', JSON.stringify(existingData));
    
    // Show success message
    Swal.fire({
        title: 'Thành công!',
        text: `Đã lưu chấm công ngày ${new Date(date).toLocaleDateString('vi-VN')}`,
        icon: 'success',
        timer: 1500,
        showConfirmButton: false
    });
    
    hideAttendanceForm();
    loadAttendanceData();
    renderTodayAttendanceButton();
}

function loadAttendanceData() {
    const filterMonth = document.getElementById('filterMonth').value;
    const filterWorkType = document.getElementById('filterWorkType').value;
    const filterNDTMethod = document.getElementById('filterNDTMethod').value;
    const searchKeyword = document.getElementById('searchKeyword').value.toLowerCase();
    
    // Load data from localStorage
    let data = JSON.parse(localStorage.getItem('attendanceData') || '[]');
    
    // Filter by month
    if (filterMonth) {
        data = data.filter(item => item.date.startsWith(filterMonth));
    }
    
    // Filter by work type
    if (filterWorkType) {
        data = data.filter(item => item.workType === filterWorkType);
    }
    
    // Filter by NDT method
    if (filterNDTMethod) {
        data = data.filter(item => item.ndtMethod === filterNDTMethod);
    }
    
    // Filter by search keyword
    if (searchKeyword) {
        data = data.filter(item => 
            item.constructionName.toLowerCase().includes(searchKeyword) ||
            item.workNote.toLowerCase().includes(searchKeyword)
        );
    }
    
    // Sort by date descending
    data.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    attendanceData = data;
    renderAttendanceTable();
    updateStatistics();
    updateCurrentMonthDisplay(filterMonth);
}

function renderAttendanceTable() {
    const tbody = document.getElementById('attendanceTableBody');
    
    if (attendanceData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-calendar-times fa-2x mb-2 d-block opacity-50"></i>
                    Không có dữ liệu chấm công
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = attendanceData.map(record => {
        const formattedDate = new Date(record.date).toLocaleDateString('vi-VN');
        
        let workTypeBadge = '';
        switch(record.workType) {
            case 'office':
                workTypeBadge = '<span class="work-badge bg-secondary text-white"><i class="fas fa-home me-1"></i>Văn phòng</span>';
                break;
            case 'construction':
                workTypeBadge = '<span class="work-badge bg-primary text-white"><i class="fas fa-industry me-1"></i>Công trình</span>';
                break;
            case 'off':
                workTypeBadge = '<span class="work-badge bg-light text-dark"><i class="fas fa-bed me-1"></i>Nghỉ</span>';
                break;
        }
        
        const methodBadge = record.ndtMethod ? 
            `<span class="method-badge bg-warning text-dark">${record.ndtMethod}</span>` : '--';
        
        const overtimeBadge = record.overtimeUntil ? 
            `<span class="badge bg-warning">Đến ${record.overtimeUntil}</span>` : '--';
            
        const expenseFormatted = record.expenseAmount ? 
            parseInt(record.expenseAmount).toLocaleString('vi-VN') + ' VNĐ' : '--';
        
        return `
            <tr>
                <td><strong>${formattedDate}</strong></td>
                <td>${workTypeBadge}</td>
                <td>${record.constructionName || (record.workType === 'office' ? 'Hành chính' : '--')}</td>
                <td>${methodBadge}</td>
                <td>${overtimeBadge}</td>
                <td>${expenseFormatted}</td>
                <td>${record.workNote || '--'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editRecord('${record.date}')" title="Sửa">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteRecord('${record.date}')" title="Xóa">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateStatistics() {
    const totalWorkDays = attendanceData.filter(r => r.workType !== 'off').length;
    const constructionDays = attendanceData.filter(r => r.workType === 'construction').length;
    const officeDays = attendanceData.filter(r => r.workType === 'office').length;
    const overtimeDays = attendanceData.filter(r => r.overtimeUntil).length;
    
    document.getElementById('totalWorkDays').textContent = totalWorkDays;
    document.getElementById('constructionDays').textContent = constructionDays;
    document.getElementById('officeDays').textContent = officeDays;
    document.getElementById('overtimeDays').textContent = overtimeDays;
}

function updateCurrentMonthDisplay(filterMonth) {
    if (filterMonth) {
        const [year, month] = filterMonth.split('-');
        document.getElementById('currentMonth').textContent = `${month.padStart(2, '0')}/${year}`;
    } else {
    const now = new Date();
        document.getElementById('currentMonth').textContent = `${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
    }
}

function clearFilter() {
    document.getElementById('filterMonth').value = new Date().toISOString().slice(0, 7);
    document.getElementById('filterWorkType').value = '';
    document.getElementById('filterNDTMethod').value = '';
    document.getElementById('searchKeyword').value = '';
    loadAttendanceData();
}

function editRecord(date) {
    const record = attendanceData.find(r => r.date === date);
    if (!record) return;
    
    // Show form with existing data
    showAttendanceForm('makeup');
    
    document.getElementById('attendanceDate').value = record.date;
    document.getElementById('workType').value = record.workType;
    document.getElementById('constructionName').value = record.constructionName;
    document.getElementById('ndtMethod').value = record.ndtMethod;
    document.getElementById('overtimeUntil').value = record.overtimeUntil;
    document.getElementById('expenseAmount').value = record.expenseAmount;
    document.getElementById('workNote').value = record.workNote;
    
    toggleConstructionFields();
}

function deleteRecord(date) {
    Swal.fire({
        title: 'Xác nhận xóa?',
        text: `Bạn có chắc muốn xóa chấm công ngày ${new Date(date).toLocaleDateString('vi-VN')}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Xóa',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            let data = JSON.parse(localStorage.getItem('attendanceData') || '[]');
            data = data.filter(item => item.date !== date);
            localStorage.setItem('attendanceData', JSON.stringify(data));
            
            Swal.fire('Đã xóa!', 'Dữ liệu chấm công đã được xóa.', 'success');
            loadAttendanceData();
            renderTodayAttendanceButton();
        }
    });
}

function exportMonthlyReport() {
    const filterMonth = document.getElementById('filterMonth').value;
    console.log('Selected month:', filterMonth); // Debug log
    
    // Kiểm tra và set giá trị mặc định nếu chưa có
    if (!filterMonth) {
        const now = new Date();
        const defaultMonth = now.toISOString().slice(0, 7); // Format YYYY-MM
        document.getElementById('filterMonth').value = defaultMonth;
        console.log('Setting default month:', defaultMonth); // Debug log
    }
    
    const [year, month] = (filterMonth || document.getElementById('filterMonth').value).split('-');
    if (!year || !month) {
        Swal.fire('Lỗi', 'Tháng không hợp lệ!', 'error');
        return;
    }
    // Generate all days of the month
    const daysInMonth = new Date(year, month, 0).getDate();
    const monthData = [
        ['Ngày', 'Loại công việc', 'Công trình/Mô tả', 'Phương pháp NDT', 'Tăng ca', 'Chi phí (VNĐ)', 'Ghi chú']
    ];
    // Get attendance data for the month
    const monthAttendanceData = JSON.parse(localStorage.getItem('attendanceData') || '[]')
        .filter(item => item.date.startsWith(filterMonth));
    let hasData = false;
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const record = monthAttendanceData.find(r => r.date === dateStr);
        if (record) hasData = true;
        if (record) {
            let workTypeText = '';
            switch(record.workType) {
                case 'office': workTypeText = 'Văn phòng'; break;
                case 'construction': workTypeText = 'Công trình'; break;
                case 'off': workTypeText = 'Nghỉ'; break;
            }
            monthData.push([
                new Date(dateStr).toLocaleDateString('vi-VN'),
                workTypeText,
                record.constructionName || (record.workType === 'office' ? 'Hành chính' : ''),
                record.ndtMethod || '',
                record.overtimeUntil ? `Đến ${record.overtimeUntil}` : '',
                record.expenseAmount || '',
                record.workNote || ''
            ]);
        } else {
            // Empty row for days not attended
            monthData.push([
                new Date(dateStr).toLocaleDateString('vi-VN'),
                '', '', '', '', '', ''
            ]);
        }
    }
    if (!hasData) {
        Swal.fire('Thông báo', 'Không có dữ liệu chấm công nào trong tháng này!', 'info');
        return;
    }
    // Create and download Excel file
    try {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(monthData);
        ws['!cols'] = [
            { width: 12 }, { width: 15 }, { width: 25 }, 
            { width: 15 }, { width: 12 }, { width: 15 }, { width: 30 }
        ];
        XLSX.utils.book_append_sheet(wb, ws, `Chấm công ${month}-${year}`);
        const shortYear = year.slice(-2);
        const filename = `Bảng chấm công Nhân viên ${month.padStart(2, '0')}-${shortYear}.xlsx`;
        XLSX.writeFile(wb, filename);
        console.log('Đã xuất file:', filename);
        Swal.fire({
            title: 'Xuất Excel thành công!',
            text: `File đã được lưu: ${filename}`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
    } catch (err) {
        console.error('Lỗi xuất Excel:', err);
        Swal.fire('Lỗi', 'Không thể xuất file Excel. Vui lòng thử lại hoặc kiểm tra trình duyệt!', 'error');
    }
}

function exportCurrentView() {
    if (attendanceData.length === 0) {
        Swal.fire('Thông báo', 'Không có dữ liệu để xuất!', 'info');
        return;
    }
    
    const exportData = [
        ['Ngày', 'Loại công việc', 'Công trình/Mô tả', 'Phương pháp NDT', 'Tăng ca', 'Chi phí (VNĐ)', 'Ghi chú']
    ];
    
    attendanceData.forEach(record => {
        let workTypeText = '';
        switch(record.workType) {
            case 'office': workTypeText = 'Văn phòng'; break;
            case 'construction': workTypeText = 'Công trình'; break;
            case 'off': workTypeText = 'Nghỉ'; break;
        }
        
        exportData.push([
            new Date(record.date).toLocaleDateString('vi-VN'),
            workTypeText,
            record.constructionName || (record.workType === 'office' ? 'Hành chính' : ''),
            record.ndtMethod || '',
            record.overtimeUntil ? `Đến ${record.overtimeUntil}` : '',
            record.expenseAmount || '',
            record.workNote || ''
        ]);
    });
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    
    ws['!cols'] = [
        { width: 12 }, { width: 15 }, { width: 25 }, 
        { width: 15 }, { width: 12 }, { width: 15 }, { width: 30 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Dữ liệu lọc');
    
    const now = new Date();
    const filename = `ChamCong_Loc_${now.getDate()}_${now.getMonth() + 1}_${now.getFullYear()}.xlsx`;
    XLSX.writeFile(wb, filename);
    
    Swal.fire({
        title: 'Xuất Excel thành công!',
        text: `File đã được lưu: ${filename}`,
        icon: 'success',
        timer: 2000,
        showConfirmButton: false
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    const filterMonth = document.getElementById('filterMonth').value;
    updateCurrentMonthDisplay(filterMonth);
    renderTodayAttendanceButton();
    loadAttendanceData();
});

// Update month display when filter changes
document.getElementById('filterMonth').addEventListener('change', function() {
    updateCurrentMonthDisplay(this.value);
    loadAttendanceData();
});
</script>
{% endblock %} 