{% extends "dashboard/dashboard_base.html" %}
{% load static %}

{% block title %}Chấm công - Dashboard{% endblock %}

{% block page_title %}
<i class="fas fa-calendar-check text-primary me-2"></i>Chấm công - {{ user.get_full_name|default:user.username }}
<small class="text-muted ms-2">({{ user.user_profile.role|default:"Nhân viên" }})</small>
{% endblock %}

{% block extra_css %}
{% csrf_token %}
<style>
    /* Reset và Base Styles */
    * {
        box-sizing: border-box;
    }
    
    .container-fluid {
        padding: 0 15px !important;
        width: 100% !important;
        max-width: none !important;
    }
    
    .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    [class*="col-"] {
        padding-left: 15px !important;
        padding-right: 15px !important;
    }
    
    /* Modern Card System */
    .modern-card {
        background: #ffffff;
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
        width: 100%;
    }
    
    .modern-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    
    .modern-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px 12px 0 0;
        border: none;
    }
    
    .modern-card-body {
        padding: 1.5rem;
    }
    
    /* Button System */
    .modern-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .modern-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        text-decoration: none;
    }
    
    .modern-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .modern-btn-success {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        color: white;
    }
    
    .modern-btn-outline {
        background: transparent;
        border: 2px solid #667eea;
        color: #667eea;
    }
    
    .modern-btn-outline:hover {
        background: #667eea;
        color: white;
    }
    
    /* Selection Cards */
    .selection-card {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        height: 100%;
        margin-bottom: 1rem;
    }
    
    .selection-card:hover {
        border-color: #667eea;
        background: #f0f4ff;
        transform: translateY(-2px);
    }
    
    .selection-card.active {
        border-color: #667eea;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }
    
    /* Stats Cards */
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        height: 100%;
        margin-bottom: 1rem;
    }
    
    .stats-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .stats-card.success {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    }
    
    .stats-card.info {
        background: linear-gradient(135deg, #3498db 0%, #85c1e9 100%);
    }
    
    .stats-card.warning {
        background: linear-gradient(135deg, #f39c12 0%, #f7dc6f 100%);
    }
    
    /* Text Gradient */
    .text-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 0 10px !important;
        }
        
        .modern-card-body {
            padding: 1rem;
        }
        
        .modern-btn {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }
        
        .stats-card {
            padding: 1rem;
        }
    }
    
    @media (max-width: 576px) {
        .container-fluid {
            padding: 0 5px !important;
        }
        
        .modern-card-header {
            padding: 0.75rem 1rem;
        }
        
        .modern-card-body {
            padding: 0.75rem;
        }
    }
    
    /* Approval Status Styles */
    .approval-status {
        border-top: 1px solid #e9ecef;
        padding-top: 15px;
    }
    
    .approval-item {
        text-align: center;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .approval-item.approved {
        background-color: rgba(40, 167, 69, 0.1);
        border: 1px solid rgba(40, 167, 69, 0.3);
    }
    
    .approval-item.rejected {
        background-color: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.3);
    }
    
    .approval-item.pending {
        background-color: rgba(108, 117, 125, 0.1);
        border: 1px solid rgba(108, 117, 125, 0.3);
    }
    
    .approval-item small {
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .approval-item .badge {
        font-size: 0.8rem;
        padding: 4px 8px;
    }
    
    /* Month Filter Styles */
    .month-filter-dropdown {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .month-option {
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 4px;
        margin: 2px 8px;
    }
    
    .month-option:hover {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }
    
    .month-option.active {
        background-color: #0d6efd;
        color: white;
    }
    
    .month-option.current {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
        font-weight: 600;
    }
    
    .month-option.current:hover {
        background-color: #198754;
        color: white;
    }
    
    .month-year-separator {
        border-top: 1px solid #e9ecef;
        margin: 8px 0;
        padding-top: 8px;
    }
    
    .year-header {
        font-weight: 600;
        color: #6c757d;
        padding: 4px 16px;
        font-size: 0.9rem;
    }
    
    /* Month dropdown scroll styles */
    #monthFilterMenu {
        max-height: 200px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #6c757d #f8f9fa;
    }
    
    #monthFilterMenu::-webkit-scrollbar {
        width: 6px;
    }
    
    #monthFilterMenu::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 3px;
    }
    
    #monthFilterMenu::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 3px;
    }
    
    #monthFilterMenu::-webkit-scrollbar-thumb:hover {
        background: #495057;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <!-- Statistics - Đặt lên đầu -->
    <div class="row">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Thống kê tháng <span id="currentMonth">{{ "now"|date:"m/Y" }}</span>
                        </h6>
                        <div class="d-flex align-items-center">
                            <div class="dropdown me-2">
                                <button class="btn btn-outline-info btn-sm" type="button" id="monthFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span id="currentMonthDisplay">Tháng 8</span>
                                    <i class="fas fa-chevron-down ms-1"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" id="monthFilterMenu" style="min-width: 150px;">
                                    <li class="dropdown-header">
                                        <span class="fw-bold">Chọn tháng</span>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li id="monthOptionsList">
                                        <!-- Month options will be generated here -->
                                    </li>
                                </ul>
                            </div>
                            <div class="dropdown me-2">
                                <button class="btn btn-outline-warning btn-sm" type="button" id="yearFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span id="currentYearDisplay">2025</span>
                                    <i class="fas fa-chevron-down ms-1"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" id="yearFilterMenu" style="min-width: 120px;">
                                    <li class="dropdown-header">
                                        <span class="fw-bold">Chọn năm</span>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li id="yearOptionsList">
                                        <!-- Year options will be generated here -->
                                    </li>
                                </ul>
                            </div>
                            {% if user.is_superuser or user.user_profile.role == 'company' %}
                            <button class="btn btn-success btn-sm" type="button" id="exportDataBtn" onclick="exportAttendanceData()" title="Xuất dữ liệu chấm công">
                                <i class="fas fa-download me-1"></i>Export Data
                            </button>

                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modern-card-body">
                    <div class="row">
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <div class="stats-card">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-1" id="totalWorkDays">0/0</h3>
                                        <small>Ngày đi làm</small>
                                    </div>
                                    <div class="stats-icon">
                                        <i class="fas fa-calendar-check fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <div class="stats-card success">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-1" id="constructionDays">0</h3>
                                        <small>Công trường</small>
                                    </div>
                                    <div class="stats-icon">
                                        <i class="fas fa-hard-hat fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <div class="stats-card info">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-1" id="officeDays">0</h3>
                                        <small>Văn phòng</small>
                                    </div>
                                    <div class="stats-icon">
                                        <i class="fas fa-building fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <div class="stats-card primary">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-1" id="trainingDays">0</h3>
                                        <small>Đào tạo</small>
                                    </div>
                                    <div class="stats-icon">
                                        <i class="fas fa-graduation-cap fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <div class="stats-card warning">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-1" id="leaveWithPermission">0</h3>
                                        <small>Nghỉ có phép</small>
                                    </div>
                                    <div class="stats-icon">
                                        <i class="fas fa-calendar-minus fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <div class="stats-card danger">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-1" id="leaveWithoutPermission">0</h3>
                                        <small>Nghỉ không phép</small>
                                    </div>
                                    <div class="stats-icon">
                                        <i class="fas fa-calendar-times fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <div class="stats-card secondary">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-1" id="overtimeHours">0h</h3>
                                        <small>Tổng tăng ca</small>
                                    </div>
                                    <div class="stats-icon">
                                        <i class="fas fa-clock fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <div class="stats-card dark">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h3 class="mb-1" id="totalExpenses">0đ</h3>
                                        <small>Tổng chi phí</small>
                                    </div>
                                    <div class="stats-icon">
                                        <i class="fas fa-money-bill-wave fa-2x opacity-75"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chấm công hôm nay -->
    <div class="row">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-check me-2"></i>
                        Chấm công hôm nay - {{ "now"|date:"d/m/Y" }}
                    </h5>
                </div>
                <div class="modern-card-body">
                    <div class="row">
                        <div class="col-12">
                            <div id="todayAttendanceForm" class="d-flex flex-wrap">
                                <!-- Buttons sẽ render động -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Form Section -->
    <div class="row" id="attendanceFormSection" style="display: none;">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h6 class="mb-0" id="formTitle">
                        <i class="fas fa-edit me-2"></i>Chấm công
                    </h6>
                </div>
                <div class="modern-card-body">
                    <form id="attendanceForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ngày chấm công</label>
                                    <input type="date" class="form-control" id="attendanceDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Loại công việc</label>
                                    <select class="form-select" id="workType" onchange="toggleConstructionFields()" required>
                                        <option value="">Chọn loại công việc</option>
                                        <option value="W">Công trường</option>
                                        <option value="O">Văn phòng</option>
                                        <option value="T">Đào tạo</option>
                                        <option value="P">Nghỉ có phép</option>
                                        <option value="N">Nghỉ không phép</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="constructionFields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Tên công trình</label>
                                        <input type="text" class="form-control" id="constructionName" placeholder="Nhập tên công trình">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Phương pháp NDT</label>
                                        <select class="form-select" id="ndtMethod" onchange="toggleMetersFields()">
                                            <option value="">Chọn phương pháp</option>
                                            <option value="MT">MT - Magnetic Testing</option>
                                            <option value="UT">UT - Ultrasonic Testing</option>
                                            <option value="RT">RT - Radiographic Testing</option>
                                            <option value="VT">VT - Visual Testing</option>
                                            <option value="PAUT">PAUT - Phased Array Ultrasonic Testing</option>
                                            <option value="TOFD">TOFD - Time of Flight Diffraction</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Phần nhập số mét vượt cho PAUT -->
                            <div id="pautMetersField" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-ruler me-2"></i>Số mét vượt PAUT
                                            </label>
                                            <input type="number" class="form-control" id="pautMeters" placeholder="Nhập số mét vượt PAUT" step="0.01" min="0" value="0">
                                            <small class="text-muted">Số mét vượt cho phương pháp PAUT</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Phần nhập số mét vượt cho TOFD -->
                            <div id="tofdMetersField" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-ruler me-2"></i>Số mét vượt TOFD
                                            </label>
                                            <input type="number" class="form-control" id="tofdMeters" placeholder="Nhập số mét vượt TOFD" step="0.01" min="0" value="0">
                                            <small class="text-muted">Số mét vượt cho phương pháp TOFD</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="shiftSection" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-clock me-2"></i>Ca làm việc
                                </label>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="selection-card" onclick="handleCardClick(event, 'dayShift')">
                                            <div class="d-flex align-items-center justify-content-center mb-2">
                                                <input class="form-check-input me-2" type="checkbox" id="dayShift" value="day" checked onchange="updateOvertimeSections()">
                                                <label class="form-check-label fw-bold mb-0" for="dayShift">
                                                    <i class="fas fa-sun text-warning me-2"></i>Ca ngày
                                                </label>
                                            </div>
                                            <div class="small text-muted">7h30-11h30, 13h-17h</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="selection-card" onclick="handleCardClick(event, 'nightShift')">
                                            <div class="d-flex align-items-center justify-content-center mb-2">
                                                <input class="form-check-input me-2" type="checkbox" id="nightShift" value="night" onchange="updateOvertimeSections()">
                                                <label class="form-check-label fw-bold mb-0" for="nightShift">
                                                    <i class="fas fa-moon text-info me-2"></i>Ca đêm
                                                </label>
                                            </div>
                                            <div class="small text-muted">19h-23h, 0h-4h</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="overtimeSection" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-clock me-2"></i>Tăng ca
                                </label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div id="dayOvertimeSection" style="display: none;">
                                            <div class="mb-3">
                                                <label class="form-label">Giờ kết thúc (ca ngày)</label>
                                                <input type="time" class="form-control" id="dayOvertimeEnd" onchange="calculateOvertime()" placeholder="VD: 20:00">
                                                <small class="text-muted">Tính tăng ca từ 17:00</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="nightOvertimeSection" style="display: none;">
                                            <div class="mb-3">
                                                <label class="form-label">Giờ kết thúc (ca đêm)</label>
                                                <input type="time" class="form-control" id="nightOvertimeEnd" onchange="calculateOvertime()" placeholder="VD: 06:00">
                                                <small class="text-muted">Tính tăng ca từ 04:00</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Tổng giờ tăng ca</label>
                                            <input type="text" class="form-control" id="overtimeHours" readonly>
                                            <small class="text-muted">Tự động tính từ giờ kết thúc ca</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="expenseSection" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-money-bill me-2"></i>Chi phí
                                </label>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <div class="mb-2">
                                            <label class="form-label small fw-bold">
                                                <i class="fas fa-bed text-primary me-1"></i>Khách sạn (VNĐ)
                                            </label>
                                            <input type="number" class="form-control" id="hotelExpense" placeholder="0" min="0" step="1000">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-2">
                                            <label class="form-label small fw-bold">
                                                <i class="fas fa-shopping-cart text-primary me-1"></i>Mua sắm (VNĐ)
                                            </label>
                                            <input type="number" class="form-control" id="shoppingExpense" placeholder="0" min="0" step="1000">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-2">
                                            <label class="form-label small fw-bold">
                                                <i class="fas fa-phone text-info me-1"></i>Điện thoại (VNĐ)
                                            </label>
                                            <input type="number" class="form-control" id="phoneExpense" placeholder="0" min="0" step="1000">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-2">
                                            <label class="form-label small fw-bold">
                                                <i class="fas fa-plus text-warning me-1"></i>Khác (VNĐ)
                                            </label>
                                            <input type="number" class="form-control" id="otherExpense" placeholder="0" min="0" step="1000">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3" id="otherExpenseField" style="display: none;">
                                            <label class="form-label">Mô tả chi phí khác</label>
                                            <input type="text" class="form-control" id="otherExpenseDesc" placeholder="Mô tả chi phí">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-sticky-note me-2"></i>Ghi chú
                            </label>
                            <textarea class="form-control" id="workNote" rows="3" placeholder="Ghi chú công việc..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="button" class="modern-btn modern-btn-primary" onclick="saveAttendance()">
                                        <i class="fas fa-save me-2"></i>Lưu chấm công
                                    </button>
                                    <button type="button" class="modern-btn modern-btn-outline" onclick="hideAttendanceForm()">
                                        <i class="fas fa-times me-2"></i>Hủy
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Data -->
    <div class="row">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-2"></i>Dữ liệu chấm công
                    </h6>
                </div>
                <div class="modern-card-body">
                    <div id="attendanceTableContainer">
                        <p class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Đang tải dữ liệu...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leave Request Section -->
    <div class="row">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-times me-2"></i>Xin nghỉ phép
                    </h6>
                </div>
                <div class="modern-card-body">
                    <div id="leaveRequestContainer">
                        <p class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Đang tải dữ liệu...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leave Approval Section (for managers/admins) -->
    <div class="row" id="leaveApprovalSection" style="display: none;">
        <div class="col-12">
            <div class="modern-card">
                <div class="modern-card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-user-check me-2"></i>Phê duyệt nghỉ phép
                    </h6>
                    <!-- Test buttons đã được xóa -->
                </div>
                <div class="modern-card-body">
                    <div id="leaveApprovalContainer">
                        <p class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Đang tải dữ liệu...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leave Request Modal -->
<div class="modal fade" id="leaveRequestModal" tabindex="-1" aria-labelledby="leaveRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="leaveRequestModalLabel">
                    <i class="fas fa-calendar-times me-2"></i>Xin nghỉ phép
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="leaveRequestForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ngày bắt đầu nghỉ *</label>
                                <input type="date" class="form-control" id="leaveStartDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ngày kết thúc nghỉ *</label>
                                <input type="date" class="form-control" id="leaveEndDate" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Lý do nghỉ phép *</label>
                        <input type="text" class="form-control" id="leaveReason" placeholder="Nhập lý do nghỉ phép" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Người bàn giao công việc *</label>
                                <select class="form-select" id="handoverPerson" name="handoverPerson" required>
                                    <option value="">-- Chọn người bàn giao --</option>
                                    {% for staff in staff_list %}
                                        <option value="{{ staff.user.id }}">{{ staff.user.get_full_name|default:staff.user.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Công việc bàn giao</label>
                                <textarea class="form-control" id="handoverTasks" rows="3" placeholder="Mô tả công việc cần bàn giao..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitLeaveRequest()">
                    <i class="fas fa-paper-plane me-2"></i>Gửi yêu cầu
                </button>
            </div>
        </div>
    </div>
</div>

<script>
console.log('ATTENDANCE SCRIPT LOADED!');

// Global variables
let currentMode = 'today';
let isLoadingData = false;
let CURRENT_USER = null;

// Initialize user data from global dashboard system
document.addEventListener('DOMContentLoaded', async function() {
    console.log('DOMContentLoaded triggered');
    
    // Initialize immediately and also after a delay
    console.log('Calling initializeAttendanceModule immediately...');
    await initializeAttendanceModule();
    
    setTimeout(async () => {
        console.log('Delayed initialization...');
        await initializeAttendanceModule();
    }, 500); // Increased delay
});

// Thêm event listener cho window load
window.addEventListener('load', async function() {
    console.log('Window load triggered');
    console.log('Calling initializeAttendanceModule on window load...');
    await initializeAttendanceModule();
});

async function initializeAttendanceModule() {
    try {
        console.log('Initializing attendance module...');
        
        // Get user from global dashboard system
        if (window.DASHBOARD_USER) {
            CURRENT_USER = window.DASHBOARD_USER;
            console.log('Using global dashboard user:', CURRENT_USER);
        } else {
            // Fallback to basic user info
            CURRENT_USER = {
                id: '{{ user.id }}',
                username: '{{ user.username }}',
                full_name: '{{ user.get_full_name|default:user.username }}',
                role: '{{ user.user_profile.role|default:"staff" }}'
            };
            console.log('Using fallback user:', CURRENT_USER);
        }
        
        // Debug: Log user info để kiểm tra
        console.log('=== USER DEBUG INFO ===');
        console.log('window.DASHBOARD_USER:', window.DASHBOARD_USER);
        console.log('user.id:', '{{ user.id }}');
        console.log('user.username:', '{{ user.username }}');
        console.log('user.get_full_name:', '{{ user.get_full_name|default:user.username }}');
        console.log('user.user_profile.role:', '{{ user.user_profile.role|default:"staff" }}');
        console.log('Final CURRENT_USER:', CURRENT_USER);
        
        console.log('CURRENT_USER after initialization:', CURRENT_USER);
        
        // Initialize the module
        await renderTodayAttendanceButton();
        await loadAttendanceData();
        await updateDetailedStatistics();
        
        // Initialize filter dropdowns
        generateYearOptions();
        generateMonthOptions();
        
        // Auto-apply current month filter
        await applyDateFilter(false);
        
        // Load leave history sau khi khởi tạo xong
        setTimeout(() => {
            if (CURRENT_USER && CURRENT_USER.id) {
                console.log('CURRENT_USER ready, loading leave history...');
                loadLeaveHistory();
            } else {
                console.error('CURRENT_USER not ready after timeout');
            }
        }, 500);
        
        // updateCurrentMonthDisplay(); // Tạm thời comment out
        
        console.log('Attendance module initialized successfully');
    } catch (error) {
        console.error('Error during initialization:', error);
    }
}

function updateCurrentMonthDisplay() {
    // Placeholder function - có thể implement sau
    console.log('updateCurrentMonthDisplay called');
}

// Helper functions using API with fallback to localStorage
async function getUserAttendanceData() {
    try {
        const response = await fetch('/api/attendance/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                return result.data;
            }
        }
        
        // Fallback to localStorage if API fails
        console.warn('API failed, using localStorage fallback');
        const key = `attendance_${CURRENT_USER.id}_data`;
        return JSON.parse(localStorage.getItem(key) || '[]');
    } catch (error) {
        console.error('Error fetching attendance data:', error);
        // Fallback to localStorage
        const key = `attendance_${CURRENT_USER.id}_data`;
        return JSON.parse(localStorage.getItem(key) || '[]');
    }
}

async function setUserAttendanceData(data) {
    try {
        console.log('Saving attendance data to API:', data);
        
        // Try to save to API first
        const response = await fetch('/api/attendance/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(data)
        });
        
        console.log('API response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('API response data:', result);
            if (result.success) {
                return true;
            } else {
                console.error('API returned error:', result.message);
                return false;
            }
        } else {
            const errorText = await response.text();
            console.error('API error response:', errorText);
            return false;
        }
        
    } catch (error) {
        console.error('Error saving attendance data:', error);
        return false;
    }
}

// Thay thế tất cả các hàm cũ bằng API
async function getAllLeaveRequests() {
    return await getLeaveRequestsAPI();
}

async function getUserLeaveRequests() {
    const allRequests = await getLeaveRequestsAPI();
    return allRequests.filter(req => req.userId === CURRENT_USER.id);
}

function showMakeupForm() {
    console.log('showMakeupForm called');
    showAttendanceForm('makeup');
}

function showAttendanceForm(mode) {
    console.log('showAttendanceForm called with mode:', mode);
    currentMode = mode;
    const formSection = document.getElementById('attendanceFormSection');
    const formTitle = document.getElementById('formTitle');
    const dateInput = document.getElementById('attendanceDate');
    
    if (!formSection || !formTitle || !dateInput) {
        console.error('Required form elements not found!');
        return;
    }
    
    if (mode === 'today') {
        formTitle.innerHTML = '<i class="fas fa-edit text-primary me-2"></i>Chấm công hôm nay';
        dateInput.value = new Date().toISOString().split('T')[0];
        dateInput.disabled = true;
    } else {
        formTitle.innerHTML = '<i class="fas fa-calendar-plus text-warning me-2"></i>Chấm công bù';
        dateInput.disabled = false;
    }
    
    formSection.style.display = 'block';
    console.log('Form section shown');
}

function hideAttendanceForm() {
    const formSection = document.getElementById('attendanceFormSection');
    if (formSection) {
        formSection.style.display = 'none';
    }
    clearForm();
}

function clearForm() {
    document.getElementById('workType').value = '';
    document.getElementById('constructionName').value = '';
    document.getElementById('ndtMethod').value = '';
    document.getElementById('dayShift').checked = true;
    document.getElementById('nightShift').checked = false;
    
    // Reset overtime fields
    const dayOvertimeEnd = document.getElementById('dayOvertimeEnd');
    const nightOvertimeEnd = document.getElementById('nightOvertimeEnd');
    const overtimeHours = document.getElementById('overtimeHours');
    if (dayOvertimeEnd) dayOvertimeEnd.value = '';
    if (nightOvertimeEnd) nightOvertimeEnd.value = '';
    if (overtimeHours) overtimeHours.value = '';
    
    // Reset expense inputs
    document.getElementById('hotelExpense').value = '';
    document.getElementById('shoppingExpense').value = '';
    document.getElementById('phoneExpense').value = '';
    document.getElementById('otherExpense').value = '';
    
    const otherExpenseDesc = document.getElementById('otherExpenseDesc');
    const otherExpenseField = document.getElementById('otherExpenseField');
    
    if (otherExpenseDesc) otherExpenseDesc.value = '';
    if (otherExpenseField) otherExpenseField.style.display = 'none';
    
            document.getElementById('workNote').value = '';
        document.getElementById('constructionFields').style.display = 'none';
        document.getElementById('shiftSection').style.display = 'none';
        document.getElementById('overtimeSection').style.display = 'none';
        document.getElementById('expenseSection').style.display = 'none';
        
        // Thêm event listener cho otherExpense
        const otherExpenseInput = document.getElementById('otherExpense');
        if (otherExpenseInput) {
            otherExpenseInput.addEventListener('input', toggleOtherExpense);
        }
}

// Smart card click handler - không còn cần thiết vì đã chuyển sang input số tiền
function handleCardClick(event, inputId) {
    // Focus vào input khi click vào card
    const target = event.target;
    const input = document.getElementById(inputId);
    
    // If click was on input or label, let the default behavior handle it
    if (target === input || target.tagName === 'LABEL' || target.closest('label')) {
        return;
    }
    
    // Focus vào input
    if (input) {
        input.focus();
    }
}

async function renderTodayAttendanceButton() {
    console.log('renderTodayAttendanceButton called');
    try {
        const today = new Date().toISOString().slice(0, 10);
        const data = await getUserAttendanceData();
        
        console.log('Today:', today);
        console.log('Data received:', data);
        
        // Kiểm tra data có phải array không
        if (!Array.isArray(data)) {
            console.error('Data is not an array:', data);
            data = [];
        }
        
        const todayRecord = data.find(r => r.date === today);
        console.log('Today record found:', !!todayRecord);
        
        let html = '';
        if (todayRecord) {
            html += `<button class="modern-btn modern-btn-outline" disabled style="opacity:0.6;cursor:not-allowed;">
                <i class="fas fa-check-circle me-2"></i>Đã chấm công hôm nay
            </button>`;
        } else {
            html += `<button class="modern-btn modern-btn-primary" onclick="showAttendanceForm('today')">
                <i class="fas fa-check me-2"></i>Chấm công hôm nay
            </button>`;
        }
        html += `<button class="modern-btn modern-btn-success" onclick="showMakeupForm()">
            <i class="fas fa-calendar-plus me-2"></i>Chấm công bù
        </button>`;
        html += `<button class="modern-btn modern-btn-outline" onclick="showLeaveRequestForm()">
            <i class="fas fa-calendar-times me-2"></i>Xin nghỉ phép
        </button>`;
        
        const formElement = document.getElementById('todayAttendanceForm');
        console.log('todayAttendanceForm element:', formElement);
        console.log('HTML to render:', html);
        
        if (formElement) {
            formElement.innerHTML = html;
            console.log('Buttons rendered successfully');
            
            // Test click handlers
            const buttons = formElement.querySelectorAll('button');
            console.log('Found buttons:', buttons.length);
            buttons.forEach((btn, index) => {
                console.log(`Button ${index}:`, btn.textContent.trim(), 'onclick:', btn.onclick);
            });
        } else {
            console.error('todayAttendanceForm element not found!');
        }
    } catch (error) {
        console.error('Error in renderTodayAttendanceButton:', error);
        // Fallback: hiển thị buttons mặc định
        const formElement = document.getElementById('todayAttendanceForm');
        if (formElement) {
            formElement.innerHTML = `
                <button class="modern-btn modern-btn-primary" onclick="showAttendanceForm('today')">
                    <i class="fas fa-check me-2"></i>Chấm công hôm nay
                </button>
                <button class="modern-btn modern-btn-success" onclick="showMakeupForm()">
                    <i class="fas fa-calendar-plus me-2"></i>Chấm công bù
                </button>
                <button class="modern-btn modern-btn-outline" onclick="showLeaveRequestForm()">
                    <i class="fas fa-calendar-times me-2"></i>Xin nghỉ phép
                </button>
            `;
        }
    }
}

// Additional functions
// Work schedule configuration
const WORK_SCHEDULE = {
    day: {
        morning: { start: '07:30', end: '11:30' },
        afternoon: { start: '13:00', end: '17:00' }
    },
    night: {
        shift1: { start: '19:00', end: '23:00' },
        shift2: { start: '00:00', end: '04:00' }
    }
};

function toggleConstructionFields() {
    console.log('toggleConstructionFields called');
    const workType = document.getElementById('workType').value;
    console.log('Work type selected:', workType);
    
    const constructionFields = document.getElementById('constructionFields');
    const shiftSection = document.getElementById('shiftSection');
    const overtimeSection = document.getElementById('overtimeSection');
    const expenseSection = document.getElementById('expenseSection');
    
    console.log('Elements found:', {
        constructionFields: !!constructionFields,
        shiftSection: !!shiftSection,
        overtimeSection: !!overtimeSection,
        expenseSection: !!expenseSection
    });
    
    if (workType === 'W') {
        // Công trường - hiển thị tất cả
        if (constructionFields) constructionFields.style.display = 'block';
        if (shiftSection) shiftSection.style.display = 'block';
        if (overtimeSection) overtimeSection.style.display = 'block';
        if (expenseSection) expenseSection.style.display = 'block';
        console.log('Showing all sections for work type W (Công trường)');
    } else if (workType === 'O') {
        // Văn phòng - không cần công trình, có ca làm việc và tăng ca
        if (constructionFields) constructionFields.style.display = 'none';
        if (shiftSection) shiftSection.style.display = 'block';
        if (overtimeSection) overtimeSection.style.display = 'block';
        if (expenseSection) expenseSection.style.display = 'block';
        console.log('Showing shift/overtime/expense sections for O (Văn phòng)');
    } else if (workType === 'T') {
        // Đào tạo - không cần công trình, có ca làm việc và tăng ca
        if (constructionFields) constructionFields.style.display = 'none';
        if (shiftSection) shiftSection.style.display = 'block';
        if (overtimeSection) overtimeSection.style.display = 'block';
        if (expenseSection) expenseSection.style.display = 'block';
        console.log('Showing shift/overtime/expense sections for T (Đào tạo)');
    } else if (workType === 'P' || workType === 'N') {
        // Nghỉ có phép/không phép - chỉ hiển thị ghi chú
        if (constructionFields) constructionFields.style.display = 'none';
        if (shiftSection) shiftSection.style.display = 'none';
        if (overtimeSection) overtimeSection.style.display = 'none';
        if (expenseSection) expenseSection.style.display = 'none';
        console.log('Hiding all sections for P/N (Nghỉ)');
    } else {
        // Chưa chọn - ẩn tất cả
        if (constructionFields) constructionFields.style.display = 'none';
        if (shiftSection) shiftSection.style.display = 'none';
        if (overtimeSection) overtimeSection.style.display = 'none';
        if (expenseSection) expenseSection.style.display = 'none';
        console.log('Hiding all sections - no selection');
    }
    
    // Cập nhật hiển thị section tăng ca theo ca được chọn
    updateOvertimeSections();
}

function toggleMetersFields() {
    console.log('toggleMetersFields called');
    const ndtMethod = document.getElementById('ndtMethod').value;
    const pautMetersField = document.getElementById('pautMetersField');
    const tofdMetersField = document.getElementById('tofdMetersField');
    
    console.log('NDT Method selected:', ndtMethod);
    console.log('PAUT meters field found:', !!pautMetersField);
    console.log('TOFD meters field found:', !!tofdMetersField);
    
    // Ẩn tất cả trường nhập số mét vượt trước
    if (pautMetersField) {
        pautMetersField.style.display = 'none';
    }
    if (tofdMetersField) {
        tofdMetersField.style.display = 'none';
    }
    
    // Hiển thị trường tương ứng với phương pháp được chọn
    if (ndtMethod === 'PAUT') {
        if (pautMetersField) {
            pautMetersField.style.display = 'block';
            console.log('Showing PAUT meters field');
        }
    } else if (ndtMethod === 'TOFD') {
        if (tofdMetersField) {
            tofdMetersField.style.display = 'block';
            console.log('Showing TOFD meters field');
        }
    } else {
        console.log('Hiding all meters fields for other methods');
    }
}

function updateOvertimeSections() {
    console.log('updateOvertimeSections called');
    const dayShift = document.getElementById('dayShift').checked;
    const nightShift = document.getElementById('nightShift').checked;
    
    console.log('Shift selection:', { dayShift, nightShift });
    
    // Ẩn tất cả section trước
    const dayOvertimeSection = document.getElementById('dayOvertimeSection');
    const nightOvertimeSection = document.getElementById('nightOvertimeSection');
    
    console.log('Overtime sections found:', {
        dayOvertimeSection: !!dayOvertimeSection,
        nightOvertimeSection: !!nightOvertimeSection
    });
    
    if (dayOvertimeSection) {
        dayOvertimeSection.style.display = 'none';
        console.log('Hidden day overtime section');
    }
    if (nightOvertimeSection) {
        nightOvertimeSection.style.display = 'none';
        console.log('Hidden night overtime section');
    }
    
    // Hiển thị section theo ca được chọn
    if (dayShift && dayOvertimeSection) {
        dayOvertimeSection.style.display = 'block';
        console.log('Showing day overtime section');
    }
    
    if (nightShift && nightOvertimeSection) {
        nightOvertimeSection.style.display = 'block';
        console.log('Showing night overtime section');
    }
    
    // Tính lại tăng ca
    calculateOvertime();
}

function calculateOvertime() {
    const dayShift = document.getElementById('dayShift').checked;
    const nightShift = document.getElementById('nightShift').checked;
    
    let totalOvertimeHours = 0;
    let overtimeDetails = [];
    
    // Tính tăng ca ngày (từ 17h00)
    if (dayShift) {
        const dayOvertimeEnd = document.getElementById('dayOvertimeEnd');
        if (dayOvertimeEnd && dayOvertimeEnd.value) {
            const standardEnd = new Date(`2000-01-01T17:00:00`);
            const overtimeEnd = new Date(`2000-01-01T${dayOvertimeEnd.value}`);
            
            if (overtimeEnd > standardEnd) {
                const overtimeHours = (overtimeEnd - standardEnd) / (1000 * 60 * 60);
                totalOvertimeHours += overtimeHours;
                overtimeDetails.push(`Ca ngày: ${overtimeHours.toFixed(1)}h (17:00 → ${dayOvertimeEnd.value})`);
                console.log('Tăng ca ngày:', overtimeHours.toFixed(1), 'giờ');
            }
        }
    }
    
    // Tính tăng ca đêm (từ 04h00)
    if (nightShift) {
        const nightOvertimeEnd = document.getElementById('nightOvertimeEnd');
        if (nightOvertimeEnd && nightOvertimeEnd.value) {
            const standardEnd = new Date(`2000-01-01T04:00:00`);
            const overtimeEnd = new Date(`2000-01-01T${nightOvertimeEnd.value}`);
            
            if (overtimeEnd > standardEnd) {
                const overtimeHours = (overtimeEnd - standardEnd) / (1000 * 60 * 60);
                totalOvertimeHours += overtimeHours;
                overtimeDetails.push(`Ca đêm: ${overtimeHours.toFixed(1)}h (04:00 → ${nightOvertimeEnd.value})`);
                console.log('Tăng ca đêm:', overtimeHours.toFixed(1), 'giờ');
            }
        }
    }
    
    const overtimeHoursField = document.getElementById('overtimeHours');
    if (overtimeHoursField) {
        overtimeHoursField.value = totalOvertimeHours.toFixed(1);
        
        // Thêm tooltip hoặc hiển thị chi tiết
        if (overtimeDetails.length > 0) {
            overtimeHoursField.title = overtimeDetails.join('\n');
        }
    }
    
    console.log('Tổng tăng ca:', totalOvertimeHours.toFixed(1), 'giờ');
    console.log('Chi tiết:', overtimeDetails);
}

function toggleExpenseAmount() {
    // Không cần hiển thị/ẩn input số tiền nữa vì đã có input riêng cho từng loại chi phí
}

function toggleOtherExpense() {
    const otherValue = parseFloat(document.getElementById('otherExpense').value) || 0;
    const otherField = document.getElementById('otherExpenseField');
    
    if (otherField) {
        if (otherValue > 0) {
            otherField.style.display = 'block';
        } else {
            otherField.style.display = 'none';
            const otherExpenseDesc = document.getElementById('otherExpenseDesc');
            if (otherExpenseDesc) {
                otherExpenseDesc.value = '';
            }
        }
    }
}

// Cập nhật hàm saveAttendance để sử dụng API
async function saveAttendance() {
    const form = document.getElementById('attendanceForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const attendanceData = {
        date: document.getElementById('attendanceDate').value,
        workType: document.getElementById('workType').value,
        constructionName: document.getElementById('constructionName').value,
        ndtMethod: document.getElementById('ndtMethod').value,
        pautMeters: parseFloat(document.getElementById('pautMeters')?.value) || 0,
        tofdMeters: parseFloat(document.getElementById('tofdMeters')?.value) || 0,
        dayShift: document.getElementById('dayShift').checked,
        nightShift: document.getElementById('nightShift').checked,
        dayOvertimeEnd: document.getElementById('dayOvertimeEnd')?.value || '',
        nightOvertimeEnd: document.getElementById('nightOvertimeEnd')?.value || '',
        overtimeHours: document.getElementById('overtimeHours')?.value || '0',
        hotelExpense: parseFloat(document.getElementById('hotelExpense').value) || 0,
        shoppingExpense: parseFloat(document.getElementById('shoppingExpense').value) || 0,
        phoneExpense: parseFloat(document.getElementById('phoneExpense').value) || 0,
        otherExpense: parseFloat(document.getElementById('otherExpense').value) || 0,
        otherExpenseDesc: document.getElementById('otherExpenseDesc')?.value || '',
        workNote: document.getElementById('workNote')?.value || '',
        timestamp: new Date().toISOString()
    };
    
    try {
        // Save single record to API
        const success = await setUserAttendanceData(attendanceData);
        console.log('Save attendance result:', success);
        
        if (success) {
            // Update UI
            hideAttendanceForm();
            await loadAttendanceData();
            await renderTodayAttendanceButton();
            updateDetailedStatistics();
            
            // Show success message
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: 'Đã lưu chấm công thành công.',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        } else {
            console.error('setUserAttendanceData returned false');
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Không thể lưu chấm công. Vui lòng thử lại.',
                });
            }
        }
    } catch (error) {
        console.error('Error saving attendance:', error);
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: 'Không thể lưu chấm công. Vui lòng thử lại.',
            });
        }
    }
}

// Cập nhật hàm loadAttendanceData để sử dụng API
async function loadAttendanceData() {
    console.log('loadAttendanceData called for month:', currentFilterMonthValue);
    try {
        const data = await getUserAttendanceData();
        const container = document.getElementById('attendanceTableContainer');
        
        // Filter data by selected month
        const filteredData = data.filter(record => {
            const recordMonth = record.date.substring(0, 7); // Get YYYY-MM from date
            return recordMonth === currentFilterMonthValue;
        });
        
        console.log('Total records:', data.length, 'Filtered records:', filteredData.length);
        
        if (filteredData.length === 0) {
            container.innerHTML = `<p class="text-center text-muted">Chưa có dữ liệu chấm công tháng ${currentFilterMonthValue}</p>`;
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += '<thead><tr><th>Ngày</th><th>Loại công việc</th><th>Công trình</th><th>Phương pháp</th><th>Số mét vượt</th><th>Ca làm việc</th><th>Tăng ca</th><th>Chi phí</th><th>Thao tác</th></tr></thead><tbody>';
        
        filteredData.forEach(record => {
            const workTypeMap = {
                'W': 'Công trường',
                'O': 'Văn phòng',
                'T': 'Đào tạo',
                'P': 'Nghỉ có phép',
                'N': 'Nghỉ không phép'
            };
            const workTypeText = workTypeMap[record.workType] || record.workType;
            const workTypeClass = record.workType === 'W' ? 'success' : 
                                 record.workType === 'O' ? 'info' : 
                                 record.workType === 'T' ? 'primary' : 
                                 record.workType === 'P' ? 'warning' : 'danger';
            
            const date = new Date(record.date).toLocaleDateString('vi-VN');
            const time = new Date(record.timestamp).toLocaleTimeString('vi-VN');
            
            // Ca làm việc
            let shiftText = '';
            if (record.dayShift && record.nightShift) {
                shiftText = 'Ca ngày + Ca đêm';
            } else if (record.dayShift) {
                shiftText = 'Ca ngày';
            } else if (record.nightShift) {
                shiftText = 'Ca đêm';
            } else {
                shiftText = '-';
            }
            
            // Tăng ca
            const overtimeText = record.overtimeHours && parseFloat(record.overtimeHours) > 0 ? 
                `${record.overtimeHours}h` : '-';
            
            // Chi phí
            let expenseText = '';
            const expenses = [];
            let totalAmount = 0;
            
            if (record.hotelExpense && parseFloat(record.hotelExpense) > 0) {
                expenses.push(`KS: ${parseFloat(record.hotelExpense).toLocaleString('vi-VN')}đ`);
                totalAmount += parseFloat(record.hotelExpense);
            }
            if (record.shoppingExpense && parseFloat(record.shoppingExpense) > 0) {
                expenses.push(`MS: ${parseFloat(record.shoppingExpense).toLocaleString('vi-VN')}đ`);
                totalAmount += parseFloat(record.shoppingExpense);
            }
            if (record.phoneExpense && parseFloat(record.phoneExpense) > 0) {
                expenses.push(`ĐT: ${parseFloat(record.phoneExpense).toLocaleString('vi-VN')}đ`);
                totalAmount += parseFloat(record.phoneExpense);
            }
            if (record.otherExpense && parseFloat(record.otherExpense) > 0) {
                expenses.push(`Khác: ${parseFloat(record.otherExpense).toLocaleString('vi-VN')}đ`);
                totalAmount += parseFloat(record.otherExpense);
            }
            
            if (expenses.length > 0) {
                expenseText = expenses.join(', ');
                if (totalAmount > 0) {
                    expenseText += ` (Tổng: ${totalAmount.toLocaleString('vi-VN')}đ)`;
                }
            } else {
                expenseText = '-';
            }
            
            // Số mét vượt
            let metersText = '';
            if (record.ndtMethod === 'PAUT' && record.pautMeters && parseFloat(record.pautMeters) > 0) {
                metersText = `PAUT: ${parseFloat(record.pautMeters).toFixed(2)}m`;
            } else if (record.ndtMethod === 'TOFD' && record.tofdMeters && parseFloat(record.tofdMeters) > 0) {
                metersText = `TOFD: ${parseFloat(record.tofdMeters).toFixed(2)}m`;
            } else {
                metersText = '-';
            }
            
            // Thêm nút chỉnh sửa nếu có thể
            const editButton = record.canBeEdited ? 
                `<button class="btn btn-sm btn-outline-primary" onclick="editAttendanceRecord('${record.date}')">
                    <i class="fas fa-edit"></i>
                </button>` : '';
            
            html += `<tr>
                <td>${date}</td>
                <td><span class="badge bg-${workTypeClass}">${workTypeText}</span></td>
                <td>${record.constructionName || '-'}</td>
                <td>${record.ndtMethod || '-'}</td>
                <td>${metersText}</td>
                <td>${shiftText}</td>
                <td>${overtimeText}</td>
                <td>${expenseText}</td>
                <td>${editButton}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading attendance data:', error);
        const container = document.getElementById('attendanceTableContainer');
        container.innerHTML = '<p class="text-center text-danger">Lỗi tải dữ liệu chấm công</p>';
    }
}

// Thêm hàm chỉnh sửa bản ghi chấm công
async function editAttendanceRecord(date) {
    try {
        const data = await getUserAttendanceData();
        const record = data.find(r => r.date === date);
        
        if (!record) {
            console.error('Record not found');
            return;
        }
        
        // Điền dữ liệu vào form
        document.getElementById('attendanceDate').value = record.date;
        document.getElementById('workType').value = record.workType;
        document.getElementById('constructionName').value = record.constructionName || '';
        document.getElementById('ndtMethod').value = record.ndtMethod || '';
        document.getElementById('dayShift').checked = record.dayShift;
        document.getElementById('nightShift').checked = record.nightShift;
        document.getElementById('dayOvertimeEnd').value = record.dayOvertimeEnd || '';
        document.getElementById('nightOvertimeEnd').value = record.nightOvertimeEnd || '';
        document.getElementById('overtimeHours').value = record.overtimeHours || '0';
        document.getElementById('hotelExpense').value = record.hotelExpense || 0;
        document.getElementById('shoppingExpense').value = record.shoppingExpense || 0;
        document.getElementById('phoneExpense').value = record.phoneExpense || 0;
        document.getElementById('otherExpense').value = record.otherExpense || 0;
        document.getElementById('otherExpenseDesc').value = record.otherExpenseDesc || '';
        document.getElementById('workNote').value = record.workNote || '';
        
        // Hiển thị form
        showAttendanceForm('edit');
        
    } catch (error) {
        console.error('Error editing attendance record:', error);
    }
}

// Helper function để lấy CSRF token
function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to calculate working days in a month (Monday to Saturday, excluding Sunday)
function calculateWorkingDaysInMonth(year, month) {
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const daysInMonth = lastDay.getDate();
    
    let workingDays = 0;
    
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month - 1, day);
        const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
        
        // Count only Monday (1) to Saturday (6), exclude Sunday (0)
        if (dayOfWeek >= 1 && dayOfWeek <= 6) {
            workingDays++;
        }
    }
    
    return workingDays;
}

// Function to update detailed statistics based on filtered data
async function updateDetailedStatistics() {
    console.log('updateDetailedStatistics called for month:', currentFilterMonthValue);
    try {
        const data = await getUserAttendanceData();
        
        // Filter data by selected month
        const filteredData = data.filter(record => {
            const recordMonth = record.date.substring(0, 7);
            return recordMonth === currentFilterMonthValue;
        });
        
        console.log('Calculating statistics for', filteredData.length, 'records');
        
        // Calculate working days in the selected month
        const [year, month] = currentFilterMonthValue.split('-').map(Number);
        const totalWorkingDaysInMonth = calculateWorkingDaysInMonth(year, month);
        
        console.log(`Working days in ${month}/${year}: ${totalWorkingDaysInMonth}`);
        
        // Calculate statistics
        const stats = {
            totalWorkDays: 0,
            constructionDays: 0,
            officeDays: 0,
            trainingDays: 0,
            leaveWithPermission: 0,
            leaveWithoutPermission: 0,
            overtimeHours: 0
        };
        
        filteredData.forEach(record => {
            stats.totalWorkDays++;
            
            switch(record.workType) {
                case 'W':
                    stats.constructionDays++;
                    break;
                case 'O':
                    stats.officeDays++;
                    break;
                case 'T':
                    stats.trainingDays++;
                    break;
                case 'P':
                    stats.leaveWithPermission++;
                    break;
                case 'N':
                    stats.leaveWithoutPermission++;
                    break;
            }
            
            // Add overtime hours
            if (record.overtimeHours) {
                stats.overtimeHours += parseFloat(record.overtimeHours) || 0;
            }
        });
        
        // Update UI
        document.getElementById('totalWorkDays').textContent = `${stats.totalWorkDays}/${totalWorkingDaysInMonth}`;
        document.getElementById('constructionDays').textContent = stats.constructionDays;
        document.getElementById('officeDays').textContent = stats.officeDays;
        document.getElementById('trainingDays').textContent = stats.trainingDays;
        document.getElementById('leaveWithPermission').textContent = stats.leaveWithPermission;
        document.getElementById('leaveWithoutPermission').textContent = stats.leaveWithoutPermission;
        document.getElementById('overtimeHours').textContent = `${stats.overtimeHours}h`;
        
        console.log('Statistics updated:', stats);
        console.log(`Total working days: ${stats.totalWorkDays}/${totalWorkingDaysInMonth}`);
        
    } catch (error) {
        console.error('Error updating statistics:', error);
    }
}

// Global variables for year and month selection
let currentFilterYear = new Date().getFullYear();
let currentFilterMonth = new Date().getMonth() + 1; // 1-12
let currentFilterMonthValue = new Date().toISOString().slice(0, 7); // Format: YYYY-MM for compatibility

// Function to generate year options
function generateYearOptions() {
    const yearOptionsList = document.getElementById('yearOptionsList');
    const currentYear = new Date().getFullYear();
    
    let html = '';
    for (let year = currentYear - 2; year <= currentYear; year++) {
        const isCurrentYear = year === currentYear;
        const isSelected = year === currentFilterYear;
        
        let className = 'month-option';
        if (isCurrentYear) className += ' current';
        if (isSelected) className += ' active';
        
        html += `
            <li>
                <div class="${className}" onclick="selectYear(${year})">
                    <i class="fas fa-calendar-year me-2"></i>
                    ${year}
                    ${isCurrentYear ? '<span class="badge bg-success ms-2">Hiện tại</span>' : ''}
                    ${isSelected ? '<i class="fas fa-check ms-2"></i>' : ''}
                </div>
            </li>
        `;
    }
    
    yearOptionsList.innerHTML = html;
}

// Function to generate month options
function generateMonthOptions() {
    const monthOptionsList = document.getElementById('monthOptionsList');
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth() + 1;
    
    const monthNames = [
        'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
        'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
    ];
    
    let html = '';
    for (let month = 1; month <= 12; month++) {
        const isCurrentMonth = currentFilterYear === currentYear && month === currentMonth;
        const isSelected = month === currentFilterMonth;
        
        let className = 'month-option';
        if (isCurrentMonth) className += ' current';
        if (isSelected) className += ' active';
        
        html += `
            <li>
                <div class="${className}" onclick="selectMonth(${month})">
                    <i class="fas fa-calendar me-2"></i>
                    ${monthNames[month - 1]}
                    ${isCurrentMonth ? '<span class="badge bg-success ms-2">Hiện tại</span>' : ''}
                    ${isSelected ? '<i class="fas fa-check ms-2"></i>' : ''}
                </div>
            </li>
        `;
    }
    
    monthOptionsList.innerHTML = html;
}

// Function to select a year
async function selectYear(year) {
    console.log('Selecting year:', year);
    currentFilterYear = year;
    
    // Update display
    const currentYearDisplay = document.getElementById('currentYearDisplay');
    if (currentYearDisplay) {
        currentYearDisplay.textContent = year.toString();
    }
    
    // Close dropdown
    const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('yearFilterDropdown'));
    if (dropdown) {
        dropdown.hide();
    }
    
    // Update month options for new year
    generateMonthOptions();
    
    // Apply filter
    await applyDateFilter(true);
}

// Function to select a month
async function selectMonth(month) {
    console.log('Selecting month:', month);
    currentFilterMonth = month;
    
    // Update display
    const currentMonthDisplay = document.getElementById('currentMonthDisplay');
    if (currentMonthDisplay) {
        const monthNames = [
            'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
            'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
        ];
        currentMonthDisplay.textContent = monthNames[month - 1];
    }
    
    // Close dropdown
    const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('monthFilterDropdown'));
    if (dropdown) {
        dropdown.hide();
    }
    
    // Apply filter
    await applyDateFilter(true);
}

// Function to apply date filter
async function applyDateFilter(showMessage = true) {
    const monthStr = currentFilterMonth.toString().padStart(2, '0');
    const yearStr = currentFilterYear.toString();
    const filterValue = `${yearStr}-${monthStr}`;
    
    console.log('Applying filter:', filterValue);
    currentFilterMonthValue = filterValue; // For compatibility with existing code
    
    // Update month display in statistics
    const monthDisplay = document.getElementById('currentMonth');
    if (monthDisplay) {
        const date = new Date(filterValue + '-01');
        monthDisplay.textContent = date.toLocaleDateString('vi-VN', { month: '2-digit', year: 'numeric' });
    }
    
    // Update dropdown displays
    const currentYearDisplay = document.getElementById('currentYearDisplay');
    const currentMonthDisplay = document.getElementById('currentMonthDisplay');
    
    if (currentYearDisplay) {
        currentYearDisplay.textContent = currentFilterYear.toString();
    }
    
    if (currentMonthDisplay) {
        const monthNames = [
            'Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
            'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'
        ];
        currentMonthDisplay.textContent = monthNames[currentFilterMonth - 1];
    }
    
    // Reload data with new filter
    await loadAttendanceData();
    await updateDetailedStatistics();
    
    // Update active states in dropdowns
    generateYearOptions();
    generateMonthOptions();
    
    // Show success message only if requested
    if (showMessage) {
        const date = new Date(filterValue + '-01');
        Swal.fire({
            icon: 'success',
            title: 'Đã lọc dữ liệu!',
            text: `Hiển thị dữ liệu ${date.toLocaleDateString('vi-VN', { month: 'long', year: 'numeric' })}`,
            timer: 1500,
            showConfirmButton: false
        });
    }
}

// Thay thế tất cả các hàm cũ bằng API
async function getLeaveRequestsAPI() {
    try {
        console.log('Fetching leave requests from API...');
        console.log('Current user ID:', CURRENT_USER ? CURRENT_USER.id : 'undefined');
        
        // Thêm timeout 10 giây
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch('/api/leave-requests/', {
            signal: controller.signal,
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        clearTimeout(timeoutId);
        console.log('API Response status:', response.status);
        console.log('API Response headers:', response.headers);
        
        if (!response.ok) {
            console.error('API Error:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('API Error response:', errorText);
            return [];
        }
        
        const result = await response.json();
        console.log('API Response data:', result);
        
        if (result.success) {
            console.log('Successfully fetched', result.requests.length, 'requests');
            return result.requests;
        } else {
            console.error('API returned error:', result.message);
            return [];
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            console.error('API request timeout');
        } else {
            console.error('Error fetching leave requests:', error);
        }
        return [];
    }
}

// Cập nhật loadLeaveHistory để sử dụng API hoàn toàn
async function loadLeaveHistory() {
    console.log('=== LOAD LEAVE HISTORY START ===');
    console.log('Current user:', CURRENT_USER);
    
    // Kiểm tra CURRENT_USER
    if (!CURRENT_USER || !CURRENT_USER.id) {
        console.error('CURRENT_USER not ready, cannot load leave history');
        const container = document.getElementById('leaveRequestContainer');
        if (container) {
            container.innerHTML = '<p class="text-center text-muted">Đang khởi tạo dữ liệu...</p>';
        }
        return;
    }
    
    try {
        console.log('About to call getLeaveRequestsAPI...');
        // Get requests from API
        const allRequests = await getLeaveRequestsAPI();
        console.log('All leave requests from API:', allRequests);
        
        if (!Array.isArray(allRequests)) {
            console.error('API returned invalid data:', allRequests);
            // Fallback: hiển thị thông báo không có dữ liệu
            const container = document.getElementById('leaveRequestContainer');
            if (container) {
                container.innerHTML = '<p class="text-center text-muted">Chưa có yêu cầu nghỉ phép nào</p>';
            }
            return;
        }
    
        // Kiểm tra xem user có quyền phê duyệt không
        const canApproveAny = CURRENT_USER && (
            CURRENT_USER.role === 'admin' || 
            CURRENT_USER.role === 'manager' ||
            CURRENT_USER.role === 'company' ||
            allRequests.some(req => {
                const isHandoverPerson = req.handoverPersonId && 
                                       req.handoverPersonId.toString() === CURRENT_USER.id.toString();
                console.log('Checking request:', req.id, 'handoverPersonId:', req.handoverPersonId, 'currentUserId:', CURRENT_USER.id, 'isHandoverPerson:', isHandoverPerson);
                return isHandoverPerson;
            })
        );

        console.log('Can approve any request:', canApproveAny);

        // Hiển thị section phê duyệt nếu có quyền
        if (canApproveAny) {
            console.log('Showing leave approval section...');
            await showLeaveApprovalSection(allRequests);
        } else {
            console.log('User has no approval permissions');
        }

        console.log('=== LOAD LEAVE HISTORY END ===');
        
        // Render user's own requests và requests mà user là người bàn giao
        const userRequests = allRequests.filter(req => 
            req.userId === CURRENT_USER.id || 
            (req.handoverPersonId && req.handoverPersonId.toString() === CURRENT_USER.id.toString())
        );
        console.log('User requests to render:', userRequests);
        renderUserLeaveRequests(userRequests);
        
    } catch (error) {
        console.error('Error in loadLeaveHistory:', error);
        // Hiển thị thông báo lỗi cho user
        const container = document.getElementById('leaveRequestContainer');
        if (container) {
            container.innerHTML = '<p class="text-center text-danger">Lỗi tải dữ liệu. Vui lòng thử lại.</p>';
        }
        
        // Hiển thị thông báo lỗi cho approval section
        const approvalContainer = document.getElementById('leaveApprovalContainer');
        if (approvalContainer) {
            approvalContainer.innerHTML = '<p class="text-center text-danger">Lỗi tải dữ liệu phê duyệt</p>';
        }
    }
}

async function showLeaveApprovalSection(allRequests = null) {
    try {
        const section = document.getElementById('leaveApprovalSection');
        const container = document.getElementById('leaveApprovalContainer');
        
        if (!section || !container) {
            console.error('Required elements not found');
            return;
        }
        
        // Hiển thị section
        section.style.display = 'block';
        
        // Sử dụng requests đã có hoặc lấy từ API
        if (!allRequests) {
            allRequests = await getLeaveRequestsAPI();
        }
        
        if (!Array.isArray(allRequests)) {
            console.error('API returned invalid data for approval section');
            container.innerHTML = '<p class="text-center text-danger">Lỗi tải dữ liệu phê duyệt</p>';
            return;
        }
        
        // Staff chỉ thấy requests mà họ là người được bàn giao (cấp 1)
        const filteredRequests = CURRENT_USER.role === 'staff' 
            ? allRequests.filter(req => 
                req.handoverPersonId && 
                req.handoverPersonId.toString() === CURRENT_USER.id.toString()
              )
            : allRequests;

        if (filteredRequests.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">Không có yêu cầu nghỉ phép nào</p>';
            return;
        }
        
        // Render requests
        renderLeaveApprovalRequests(filteredRequests);
        
    } catch (error) {
        console.error('Error in showLeaveApprovalSection:', error);
        const container = document.getElementById('leaveApprovalContainer');
        if (container) {
            container.innerHTML = '<p class="text-center text-danger">Lỗi tải dữ liệu phê duyệt</p>';
        }
    }
}

function renderUserLeaveRequests(requests) {
    console.log('renderUserLeaveRequests called with:', requests);
    const container = document.getElementById('leaveRequestContainer');
    console.log('Container found:', container);
    
    if (!container) {
        console.error('leaveRequestContainer not found!');
        return;
    }
    
    if (requests.length === 0) {
        console.log('No requests to render, showing empty message');
        container.innerHTML = '<p class="text-center text-muted">Chưa có yêu cầu nghỉ phép nào</p>';
        return;
    }
    
    console.log('Rendering', requests.length, 'requests');
    
    let html = '<div class="row">';
    requests.forEach(request => {
        // Xác định vai trò của user trong yêu cầu này
        const isOwner = request.userId === CURRENT_USER.id;
        const isHandoverPerson = request.handoverPersonId && request.handoverPersonId.toString() === CURRENT_USER.id.toString();
        
        let roleBadge = '';
        if (isOwner && isHandoverPerson) {
            roleBadge = '<span class="badge bg-info me-2">Yêu cầu của tôi & Cần phê duyệt</span>';
        } else if (isOwner) {
            roleBadge = '<span class="badge bg-primary me-2">Yêu cầu của tôi</span>';
        } else if (isHandoverPerson) {
            roleBadge = '<span class="badge bg-warning me-2">Cần phê duyệt (Cấp 1)</span>';
        }
        
        html += `<div class="col-md-6 mb-3">
            <div class="modern-card ${isHandoverPerson ? 'border-warning' : ''}" ${isHandoverPerson ? 'style="border-width: 2px; box-shadow: 0 4px 16px rgba(255, 193, 7, 0.15);"' : ''}>
                <div class="modern-card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">${request.reason}</h6>
                        ${roleBadge}
                    </div>
                    <p class="text-muted mb-2">
                        <i class="fas fa-calendar me-1"></i>
                        ${new Date(request.startDate).toLocaleDateString('vi-VN')} - 
                        ${new Date(request.endDate).toLocaleDateString('vi-VN')}
                    </p>
                    <p class="text-muted mb-2">
                        <i class="fas fa-user me-1"></i>
                        Người tạo: ${request.employeeName}
                    </p>
                    <p class="text-muted mb-2">
                        <i class="fas fa-user-tie me-1"></i>
                        Người được bàn giao: ${isHandoverPerson ? '<strong class="text-primary">Bạn</strong>' : (request.handoverPerson || 'Chưa chỉ định')}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-${request.status === 'approved' ? 'success' : request.status === 'rejected' ? 'danger' : 'warning'}">
                                ${request.status === 'approved' ? 'Đã duyệt' : request.status === 'rejected' ? 'Bị từ chối' : 'Chờ duyệt'}
                            </span>
                            ${request.status === 'rejected' ? `
                                <div class="mt-2">
                                    ${request.companyApproval === 'rejected' ? `<small class="text-danger d-block"><strong>Công ty trả lời:</strong> ${request.companyRejectionReason || 'Không có lý do'}</small>` : ''}
                                    ${request.managerApproval === 'rejected' ? `<small class="text-danger d-block"><strong>Quản lý trả lời:</strong> ${request.managerRejectionReason || 'Không có lý do'}</small>` : ''}
                                    ${request.handoverApproval === 'rejected' ? `<small class="text-danger d-block"><strong>Người được bàn giao trả lời:</strong> ${request.handoverRejectionReason || 'Không có lý do'}</small>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        ${isOwner ? 
                            `<button class="btn btn-danger btn-sm" onclick="deleteLeaveRequest('${request.id}')" title="Xóa yêu cầu">
                                <i class="fas fa-trash"></i>
                            </button>` : ''
                        }
                    </div>
                </div>
            </div>
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

function renderLeaveApprovalRequests(requests) {
    const container = document.getElementById('leaveApprovalContainer');
    if (!container) return;
    
    let html = '<div class="row">';
    requests.forEach(request => {
        const canApprove = canUserApproveLeave(request);
        const approvalLevel = getCurrentUserApprovalLevel(request);
        
        // Kiểm tra xem user có phải là người được bàn giao không
        const isHandoverPerson = request.handoverPersonId && 
                                request.handoverPersonId.toString() === CURRENT_USER.id.toString();
        
        console.log('Processing approval request:', request.id, 'for user:', CURRENT_USER.role);
        console.log('Request data:', request);
        
        html += `<div class="col-md-6 mb-3">
            <div class="modern-card ${isHandoverPerson ? 'border-success' : ''}" ${isHandoverPerson ? 'style="border-width: 2px; box-shadow: 0 4px 16px rgba(40, 167, 69, 0.15);"' : ''}>
                <div class="modern-card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">${request.employeeName}</h6>
                        ${getRequestStatusBadge(request)}
                    </div>
                    <p class="text-muted mb-2">
                        <i class="fas fa-calendar me-1"></i>
                        ${new Date(request.startDate).toLocaleDateString('vi-VN')} - ${new Date(request.endDate).toLocaleDateString('vi-VN')}
                    </p>
                    <p class="text-muted mb-2">
                        <i class="fas fa-file-alt me-1"></i>
                        ${request.reason}
                    </p>
                    <p class="text-muted mb-3">
                        <i class="fas fa-user me-1"></i>
                        Người được bàn giao: ${isHandoverPerson ? '<strong class="text-success">Bạn</strong>' : request.handoverPerson}
                    </p>
                    
                    <!-- Hiển thị trạng thái phê duyệt 3 cấp -->
                    <div class="approval-status mb-3">
                        <div class="row">
                            <div class="col-4">
                                <div class="approval-item ${request.handoverApproval === 'approved' ? 'approved' : request.handoverApproval === 'rejected' ? 'rejected' : 'pending'}">
                                    <small class="d-block text-muted">Người bàn giao</small>
                                    <span class="badge bg-${request.handoverApproval === 'approved' ? 'success' : request.handoverApproval === 'rejected' ? 'danger' : 'secondary'}">
                                        ${request.handoverApproval === 'approved' ? '✓' : request.handoverApproval === 'rejected' ? '✗' : '...'}
                                    </span>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="approval-item ${request.managerApproval === 'approved' ? 'approved' : request.managerApproval === 'rejected' ? 'rejected' : 'pending'}">
                                    <small class="d-block text-muted">Quản lý</small>
                                    <span class="badge bg-${request.managerApproval === 'approved' ? 'success' : request.managerApproval === 'rejected' ? 'danger' : 'secondary'}">
                                        ${request.managerApproval === 'approved' ? '✓' : request.managerApproval === 'rejected' ? '✗' : '...'}
                                    </span>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="approval-item ${request.companyApproval === 'approved' ? 'approved' : request.companyApproval === 'rejected' ? 'rejected' : 'pending'}">
                                    <small class="d-block text-muted">Công ty</small>
                                    <span class="badge bg-${request.companyApproval === 'approved' ? 'success' : request.companyApproval === 'rejected' ? '✗' : '...'}">
                                        ${request.companyApproval === 'approved' ? '✓' : request.companyApproval === 'rejected' ? '✗' : '...'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${canApprove ? `
                    <div class="approval-actions">
                        <div class="row">
                            <div class="col-6">
                                <button class="btn btn-success btn-sm w-100" onclick="approveLeave('${request.id}', '${approvalLevel}')">
                                    <i class="fas fa-check me-1"></i>Duyệt
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-danger btn-sm w-100" onclick="rejectLeave('${request.id}', '${approvalLevel}')">
                                    <i class="fas fa-times me-1"></i>Từ chối
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : getApprovalStatusMessage(request, approvalLevel)}
                </div>
            </div>
        </div>`;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Helper functions for leave approval
function canUserApproveLeave(request) {
    // Implement based on user role and request status
    return true; // Placeholder
}

function getCurrentUserApprovalLevel(request) {
    // Implement based on user role
    return 'handover'; // Placeholder
}

function getRequestStatusBadge(request) {
    const status = request.status;
    const color = status === 'approved' ? 'success' : status === 'rejected' ? 'danger' : 'warning';
    const text = status === 'approved' ? 'Đã duyệt' : status === 'rejected' ? 'Bị từ chối' : 'Chờ duyệt';
    return `<span class="badge bg-${color}">${text}</span>`;
}

function getApprovalStatusMessage(request, level) {
    return `<small class="text-muted">Chờ phê duyệt cấp ${level}</small>`;
}

// Leave Request Functions
function showLeaveRequestForm() {
    const modal = new bootstrap.Modal(document.getElementById('leaveRequestModal'));
    modal.show();
    // Nạp danh sách người bàn giao mỗi lần mở form để luôn cập nhật
    loadHandoverCandidates('');
}

async function loadHandoverCandidates(search = '') {
    try {
        const res = await fetch(`/api/users/handovers/?q=${encodeURIComponent(search)}`);
        if (!res.ok) return;
        const result = await res.json();
        const select = document.getElementById('handoverPerson');
        if (!select) return;
        select.innerHTML = '<option value="">-- Chọn người bàn giao --</option>';
        if (result.success && Array.isArray(result.users)) {
            result.users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                opt.textContent = `${u.full_name}${u.role ? ' - ' + u.role : ''}`;
                select.appendChild(opt);
            });
        }
    } catch (err) {
        console.error('Failed to load handover candidates:', err);
    }
}

async function approveLeave(requestId, level) {
    console.log(`Approving leave ${requestId} at level ${level}`);
    
    const result = await approveLeaveRequestAPI(requestId, level, 'approve');
    
    if (result.success) {
        // Refresh display
        showLeaveApprovalSection();
        loadLeaveHistory();
        
        Swal.fire('Thành công!', result.message, 'success');
    } else {
        Swal.fire('Lỗi!', result.message, 'error');
    }
}

async function rejectLeave(requestId, level) {
    console.log(`Rejecting leave ${requestId} at level ${level}`);
    
    const { value: reason } = await Swal.fire({
        title: 'Lý do từ chối',
        input: 'text',
        inputLabel: 'Nhập lý do từ chối',
        inputPlaceholder: 'Lý do từ chối...',
        showCancelButton: true,
        confirmButtonText: 'Từ chối',
        cancelButtonText: 'Hủy',
        inputValidator: (value) => {
            if (!value) {
                return 'Bạn cần nhập lý do từ chối!';
            }
        }
    });

    if (reason) {
        const result = await approveLeaveRequestAPI(requestId, level, 'reject', reason);
        
        if (result.success) {
            // Refresh display
            showLeaveApprovalSection();
            loadLeaveHistory();
            
            Swal.fire('Thành công!', result.message, 'success');
        } else {
            Swal.fire('Lỗi!', result.message, 'error');
        }
    }
}

async function deleteLeaveRequest(requestId) {
    console.log(`Deleting leave request ${requestId}`);
    
    const result = await Swal.fire({
        title: 'Xác nhận xóa',
        text: 'Bạn có chắc chắn muốn xóa yêu cầu nghỉ phép này?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Xóa',
        cancelButtonText: 'Hủy'
    });

    if (result.isConfirmed) {
        const deleteResult = await deleteLeaveRequestAPI(requestId);
        
        if (deleteResult.success) {
            // Refresh display
            loadLeaveHistory();
            
            Swal.fire('Đã xóa!', deleteResult.message, 'success');
        } else {
            Swal.fire('Lỗi!', deleteResult.message, 'error');
        }
    }
}

async function approveLeaveRequestAPI(requestId, level, action, reason = '') {
    try {
        const response = await fetch('/api/leave-requests/approve/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                request_id: requestId,
                level: level,
                action: action,
                reason: reason
            })
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error approving leave request:', error);
        return { success: false, message: 'Lỗi kết nối server' };
    }
}

async function deleteLeaveRequestAPI(requestId) {
    try {
        const response = await fetch(`/api/leave-requests/${requestId}/delete/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error deleting leave request:', error);
        return { success: false, message: 'Lỗi kết nối server' };
    }
}

async function createLeaveRequestAPI(requestData) {
    try {
        console.log('Creating leave request with data:', requestData);
        
        const response = await fetch('/api/leave-requests/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(requestData)
        });
        
        console.log('API Response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error response:', errorText);
            return { success: false, message: 'Lỗi server: ' + response.status };
        }
        
        const result = await response.json();
        console.log('API Response data:', result);
        
        return result;
    } catch (error) {
        console.error('Error creating leave request:', error);
        return { success: false, message: 'Lỗi kết nối server' };
    }
}

async function approveLeaveRequestAPI(requestId, level, action, reason = '') {
    try {
        // Get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrfToken = getCookie('csrftoken');
        
        const response = await fetch('/api/leave-requests/approve/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                request_id: requestId,
                level: level,
                action: action,
                reason: reason
            })
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error approving leave request:', error);
        return { success: false, message: 'Lỗi kết nối server' };
    }
}

async function deleteLeaveRequestAPI(requestId) {
    try {
        // Get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrfToken = getCookie('csrftoken');
        
        const response = await fetch(`/api/leave-requests/${requestId}/delete/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error deleting leave request:', error);
        return { success: false, message: 'Lỗi kết nối server' };
    }
}

// Updated functions to use API
async function submitLeaveRequest() {
    console.log('submitLeaveRequest called');
    
    const startDate = document.getElementById('leaveStartDate').value;
    const endDate = document.getElementById('leaveEndDate').value;
    const reason = document.getElementById('leaveReason').value;
    const handoverPersonSelect = document.getElementById('handoverPerson');
    const handoverTasks = document.getElementById('handoverTasks').value;

    const handoverPersonId = handoverPersonSelect.value;
    let handoverPerson = '';
    
    if (handoverPersonSelect.selectedIndex > 0) {
        handoverPerson = handoverPersonSelect.options[handoverPersonSelect.selectedIndex].text;
    }

    if (!startDate || !endDate || !reason || !handoverPersonId) {
        Swal.fire('Lỗi!', 'Vui lòng điền đầy đủ thông tin bắt buộc.', 'error');
        return;
    }

    // Create request data
    const requestData = {
        startDate: startDate,
        endDate: endDate,
        reason: reason,
        handoverPersonId: handoverPersonId,
        handoverTasks: handoverTasks,
        leave_type: 'personal'
    };

    console.log('Sending leave request:', requestData);

    // Call API
    const result = await createLeaveRequestAPI(requestData);
    
    if (result.success) {
        // Close modal and show success
        const modal = bootstrap.Modal.getInstance(document.getElementById('leaveRequestModal'));
        if (modal) modal.hide();
        
        Swal.fire({
            title: 'Gửi yêu cầu thành công!',
            text: result.message,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });

        // Clear form
        document.getElementById('leaveStartDate').value = '';
        document.getElementById('leaveEndDate').value = '';
        document.getElementById('leaveReason').value = '';
        document.getElementById('handoverPerson').value = '';
        document.getElementById('handoverTasks').value = '';

        // Refresh displays
        loadLeaveHistory();
    } else {
        Swal.fire('Lỗi!', result.message, 'error');
    }
}

function canUserApproveLeave(request) {
    console.log('=== DEBUG canUserApproveLeave ===');
    console.log('CURRENT_USER:', CURRENT_USER);
    console.log('Request:', request);
    
    if (!CURRENT_USER) {
        console.log('❌ CURRENT_USER is null/undefined');
        return false;
    }
    
    const userRole = CURRENT_USER.role;
    console.log('User role:', userRole);
    console.log('Request approval statuses:', {
        handover: request.handoverApproval,
        manager: request.managerApproval, 
        company: request.companyApproval
    });
    
    // Admin có thể phê duyệt ở BẤT KỲ cấp nào còn pending
    if (userRole === 'admin') {
        const canApprove = request.companyApproval === 'pending' || 
                          request.managerApproval === 'pending' || 
                          request.handoverApproval === 'pending';
        console.log('✓ Admin can approve:', canApprove);
        return canApprove;
    }
    
    // Company có thể phê duyệt ở BẤT KỲ cấp nào còn pending
    if (userRole === 'company') {
        const canApprove = request.companyApproval === 'pending' || 
                          request.managerApproval === 'pending' || 
                          request.handoverApproval === 'pending';
        console.log('✓ Company can approve:', canApprove);
        return canApprove;
    }
    
    // Manager có thể phê duyệt cấp manager và handover
    if (userRole === 'manager') {
        const canApprove = request.managerApproval === 'pending' || 
                          request.handoverApproval === 'pending';
        console.log('✓ Manager can approve:', canApprove);
        return canApprove;
    }
    
    // Staff chỉ có quyền phê duyệt nếu là người được bàn giao (cấp 1)
    if (userRole === 'staff') {
        const isHandoverPerson = request.handoverPersonId && 
                                request.handoverPersonId.toString() === CURRENT_USER.id.toString();
        const canApprove = isHandoverPerson && request.handoverApproval === 'pending';
        console.log('✓ Staff - isHandoverPerson:', isHandoverPerson, 'can approve:', canApprove);
        return canApprove;
    }
    
    console.log('❌ No matching role found, returning false');
    return false;
}

function getApprovalStatusMessage(request, userLevel) {
    if (!CURRENT_USER) return '<p class="text-muted small">Bạn không có quyền phê duyệt yêu cầu này</p>';
    
    const userRole = CURRENT_USER.role;
    
    // Kiểm tra xem user đã phê duyệt chưa
    if (userRole === 'admin') {
        // Admin có thể đã phê duyệt ở bất kỳ cấp nào
        if (request.companyApproval === 'approved' || 
            request.managerApproval === 'approved' || 
            request.handoverApproval === 'approved') {
            return '<p class="text-success small"><i class="fas fa-check me-1"></i>Bạn đã phê duyệt yêu cầu này</p>';
        } else if (request.companyApproval === 'rejected' || 
                   request.managerApproval === 'rejected' || 
                   request.handoverApproval === 'rejected') {
            return '<p class="text-danger small"><i class="fas fa-times me-1"></i>Bạn đã từ chối yêu cầu này</p>';
        }
    } else if (userRole === 'company') {
        // Company có thể đã phê duyệt ở bất kỳ cấp nào
        if (request.companyApproval === 'approved' || 
            request.managerApproval === 'approved' || 
            request.handoverApproval === 'approved') {
            return '<p class="text-success small"><i class="fas fa-check me-1"></i>Bạn đã phê duyệt yêu cầu này</p>';
        } else if (request.companyApproval === 'rejected' || 
                   request.managerApproval === 'rejected' || 
                   request.handoverApproval === 'rejected') {
            return '<p class="text-danger small"><i class="fas fa-times me-1"></i>Bạn đã từ chối yêu cầu này</p>';
        }
    } else if (userRole === 'manager') {
        if (request.managerApproval === 'approved') {
            return '<p class="text-success small"><i class="fas fa-check me-1"></i>Bạn đã phê duyệt yêu cầu này</p>';
        } else if (request.managerApproval === 'rejected') {
            return '<p class="text-danger small"><i class="fas fa-times me-1"></i>Bạn đã từ chối yêu cầu này</p>';
        }
    } else if (userRole === 'staff') {
        // Kiểm tra xem có phải người bàn giao không
        const isHandoverPerson = (request.handoverPersonId && CURRENT_USER.id == request.handoverPersonId) ||
                                (request.handoverPerson && CURRENT_USER.full_name === request.handoverPerson) ||
                                (request.handoverPerson && CURRENT_USER.username === request.handoverPerson);
        
        if (isHandoverPerson) {
            if (request.handoverApproval === 'approved') {
                return '<p class="text-success small"><i class="fas fa-check me-1"></i>Bạn đã phê duyệt yêu cầu này</p>';
            } else if (request.handoverApproval === 'rejected') {
                return '<p class="text-danger small"><i class="fas fa-times me-1"></i>Bạn đã từ chối yêu cầu này</p>';
            }
        }
    }
    
    return '<p class="text-muted small">Bạn không có quyền phê duyệt yêu cầu này</p>';
}

function getRequestStatusBadge(request) {
    // Kiểm tra xem có bị từ chối không
    if (request.handoverApproval === 'rejected' || 
        request.managerApproval === 'rejected' || 
        request.companyApproval === 'rejected') {
        return '<span class="badge bg-danger">Bị từ chối</span>';
    }
    
    // Kiểm tra xem đã được phê duyệt hoàn toàn chưa
    if (request.handoverApproval === 'approved' && 
        request.managerApproval === 'approved' && 
        request.companyApproval === 'approved') {
        return '<span class="badge bg-success">Đã phê duyệt</span>';
    }
    
    // Kiểm tra xem có cấp nào đã phê duyệt chưa
    const approvedCount = [request.handoverApproval, request.managerApproval, request.companyApproval]
        .filter(status => status === 'approved').length;
    
    if (approvedCount > 0) {
        return `<span class="badge bg-info">Đã phê duyệt ${approvedCount}/3</span>`;
    }
    
    // Mặc định là chờ phê duyệt
    return '<span class="badge bg-warning">Chờ phê duyệt</span>';
}

function getCurrentUserApprovalLevel(request) {
    if (!CURRENT_USER) return null;
    
    const userRole = CURRENT_USER.role;
    console.log('Getting approval level for role:', userRole, 'request:', request);
    
    // Admin có thể phê duyệt ở cấp cao nhất còn pending
    if (userRole === 'admin') {
        // Ưu tiên phê duyệt từ cấp cao xuống thấp
        if (request.companyApproval === 'pending') {
            return 'company';
        } else if (request.managerApproval === 'pending') {
            return 'manager';
        } else if (request.handoverApproval === 'pending') {
            return 'handover';
        }
        return 'company'; // Fallback
    }
    
    // Company có thể phê duyệt ở cấp cao nhất còn pending
    if (userRole === 'company') {
        // Ưu tiên phê duyệt từ cấp cao xuống thấp
        if (request.companyApproval === 'pending') {
            return 'company';
        } else if (request.managerApproval === 'pending') {
            return 'manager';
        } else if (request.handoverApproval === 'pending') {
            return 'handover';
        }
        return 'company'; // Fallback
    }
    
    // Manager có thể phê duyệt ở cấp manager  
    if (userRole === 'manager') {
        return 'manager';
    }
    
    // Staff chỉ có thể phê duyệt ở cấp handover (nếu là người được bàn giao)
    if (userRole === 'staff') {
        return 'handover';
    }
    
    console.log('Unknown role, returning null');
    return null;
}

// Show alert function
function showAlert(message, type = 'info') {
    // Tạo alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Thêm vào body
    document.body.appendChild(alertDiv);
    
    // Tự động ẩn sau 5 giây
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Export attendance data function
function exportAttendanceData() {
    // Kiểm tra quyền admin
    if (!CURRENT_USER || (CURRENT_USER.role !== 'admin' && CURRENT_USER.role !== 'company')) {
        showAlert('Bạn không có quyền xuất dữ liệu!', 'danger');
        return;
    }
    
    // Lấy tháng và năm hiện tại
    const currentMonth = document.getElementById('currentMonthDisplay').textContent;
    const currentYear = document.getElementById('currentYearDisplay').textContent;
    
    // Chuyển đổi tên tháng thành số
    const monthMap = {
        'Tháng 1': '01', 'Tháng 2': '02', 'Tháng 3': '03', 'Tháng 4': '04',
        'Tháng 5': '05', 'Tháng 6': '06', 'Tháng 7': '07', 'Tháng 8': '08',
        'Tháng 9': '09', 'Tháng 10': '10', 'Tháng 11': '11', 'Tháng 12': '12'
    };
    
    const month = monthMap[currentMonth] || '01';
    const year = currentYear || new Date().getFullYear();
    
    // Hiển thị loading
    const exportBtn = document.getElementById('exportDataBtn');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang xuất...';
    exportBtn.disabled = true;
    
    // Tạo URL export (sử dụng relative path để giữ session)
    const exportUrl = `/export/attendance/?month=${month}&year=${year}`;
    
    // Sử dụng fetch để kiểm tra response trước khi download
    fetch(exportUrl, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.blob();
    })
    .then(blob => {
        // Tạo URL cho blob
        const url = window.URL.createObjectURL(blob);
        
        // Tạo link download
        const link = document.createElement('a');
        link.href = url;
        link.download = `chamcong_${month}_${year}.json`;
        
        // Thêm vào DOM và click
        document.body.appendChild(link);
        link.click();
        
        // Cleanup
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        // Khôi phục button và hiển thị thông báo thành công
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
        showAlert(`Đã xuất dữ liệu chấm công tháng ${month}/${year} thành công!`, 'success');
    })
    .catch(error => {
        console.error('Export error:', error);
        
        // Khôi phục button và hiển thị thông báo lỗi
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
        showAlert(`Lỗi xuất dữ liệu: ${error.message}`, 'danger');
    });
}



</script>
{% endblock %} 