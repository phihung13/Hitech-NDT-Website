{% extends 'base.html' %}
{% load static %}

{% block title %}Báo cáo Dashboard - Hitech NDT{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-chart-bar"></i> Dashboard Báo cáo</h2>
        </div>
    </div>
    
    <!-- Thống kê tổng quan với animation -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-primary text-white shadow-lg hover-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="counter" data-target="{{ total_projects }}">0</h4>
                            <p>Tổng dự án</p>
                            <small>+{{ new_projects_this_month }} dự án mới tháng này</small>
                        </div>
                        <div>
                            <i class="fas fa-project-diagram fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white shadow-lg hover-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="counter" data-target="{{ active_projects }}">0</h4>
                            <p>Dự án đang thực hiện</p>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar bg-light" style="width: {{ active_percentage }}%"></div>
                            </div>
                        </div>
                        <div>
                            <i class="fas fa-play-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white shadow-lg hover-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="counter" data-target="{{ completed_projects }}">0</h4>
                            <p>Dự án hoàn thành</p>
                            <small>Tỷ lệ hoàn thành: {{ completion_rate }}%</small>
                        </div>
                        <div>
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card bg-warning text-white shadow-lg hover-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="counter" data-target="{{ total_reports }}">0</h4>
                            <p>Tổng báo cáo</p>
                            <small>{{ reports_this_week }} báo cáo tuần này</small>
                        </div>
                        <div>
                            <i class="fas fa-file-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Biểu đồ timeline và xu hướng -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-chart-line"></i> Xu hướng dự án theo thời gian</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary active" onclick="updateTimeChart('month')">Tháng</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="updateTimeChart('quarter')">Quý</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="updateTimeChart('year')">Năm</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="timelineChart" height="100"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header">
                    <h5><i class="fas fa-tasks"></i> Trạng thái dự án</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Đang thực hiện</span>
                            <span class="badge bg-primary">{{ active_projects }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Hoàn thành</span>
                            <span class="badge bg-success">{{ completed_projects }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tạm dừng</span>
                            <span class="badge bg-warning">{{ paused_projects }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Hủy bỏ</span>
                            <span class="badge bg-danger">{{ cancelled_projects }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Biểu đồ phân tích chi tiết -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header">
                    <h5><i class="fas fa-building"></i> Top 5 Công ty theo số dự án</h5>
                </div>
                <div class="card-body">
                    <canvas id="companyChart"></canvas>
                    <div class="mt-3">
                        <h6>Chi tiết:</h6>
                        {% for company in company_stats %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ company.name }}</span>
                            <div>
                                <span class="badge bg-primary me-2">{{ company.project_count }} dự án</span>
                                <span class="text-muted">{{ company.revenue|floatformat:0 }} VNĐ</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header">
                    <h5><i class="fas fa-tools"></i> Thiết bị được sử dụng nhiều nhất</h5>
                </div>
                <div class="card-body">
                    <canvas id="equipmentChart"></canvas>
                    <div class="mt-3">
                        <h6>Tỷ lệ sử dụng:</h6>
                        {% for equipment in equipment_usage %}
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>{{ equipment.name }}</span>
                                <span>{{ equipment.usage_percentage }}%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" style="width: {{ equipment.usage_percentage }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Biểu đồ phương pháp NDT -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header">
                    <h5><i class="fas fa-microscope"></i> Phương pháp NDT phổ biến</h5>
                </div>
                <div class="card-body">
                    <canvas id="methodChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header">
                    <h5><i class="fas fa-map-marker-alt"></i> Phân bố dự án theo khu vực</h5>
                </div>
                <div class="card-body">
                    <canvas id="locationChart"></canvas>
                    <div class="mt-3">
                        <div class="row">
                            {% for location in location_stats %}
                            <div class="col-12 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>{{ location.name }}</span>
                                    <span class="badge bg-info">{{ location.count }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bảng dữ liệu chi tiết -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-table"></i> Dự án gần đây</h5>
                    <a href="{% url 'project_report' %}" class="btn btn-sm btn-primary">Xem tất cả</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Tên dự án</th>
                                    <th>Công ty</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày bắt đầu</th>
                                    <th>Tiến độ</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in recent_projects %}
                                <tr>
                                    <td><strong>{{ project.name }}</strong></td>
                                    <td>{{ project.company.name }}</td>
                                    <td>
                                        {% if project.status == 'active' %}
                                            <span class="badge bg-success">Đang thực hiện</span>
                                        {% elif project.status == 'completed' %}
                                            <span class="badge bg-primary">Hoàn thành</span>
                                        {% elif project.status == 'paused' %}
                                            <span class="badge bg-warning">Tạm dừng</span>
                                        {% else %}
                                            <span class="badge bg-danger">Hủy bỏ</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ project.start_date|date:"d/m/Y" }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" style="width: {{ project.progress }}%">{{ project.progress }}%</div>
                                        </div>
                                    </td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-outline-primary">Chi tiết</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Menu báo cáo với icons lớn hơn -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5><i class="fas fa-file-export"></i> Các loại báo cáo</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <a href="{% url 'project_report' %}" class="btn btn-outline-primary btn-lg w-100 mb-3 report-card">
                                <i class="fas fa-project-diagram fa-3x mb-2"></i><br>
                                <strong>Báo cáo Dự án</strong><br>
                                <small class="text-muted">{{ total_projects }} dự án</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'thickness_report' %}" class="btn btn-outline-success btn-lg w-100 mb-3 report-card">
                                <i class="fas fa-ruler fa-3x mb-2"></i><br>
                                <strong>Báo cáo Độ dày</strong><br>
                                <small class="text-muted">{{ total_thickness_tests }} kiểm tra</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'weld_report' %}" class="btn btn-outline-info btn-lg w-100 mb-3 report-card">
                                <i class="fas fa-fire fa-3x mb-2"></i><br>
                                <strong>Báo cáo Mối hàn</strong><br>
                                <small class="text-muted">{{ total_weld_tests }} kiểm tra</small>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="#" class="btn btn-outline-warning btn-lg w-100 mb-3 report-card">
                                <i class="fas fa-chart-pie fa-3x mb-2"></i><br>
                                <strong>Báo cáo Tổng hợp</strong><br>
                                <small class="text-muted">Tất cả dữ liệu</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS cho animation và hiệu ứng -->
<style>
.hover-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.report-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.report-card:hover {
    transform: translateY(-3px);
    border-color: currentColor;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.counter {
    font-weight: bold;
    font-size: 2rem;
}

@keyframes countUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    border: none;
    border-radius: 10px;
}

.progress {
    border-radius: 10px;
}

.table th {
    border-top: none;
    font-weight: 600;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Animation cho số đếm
document.addEventListener('DOMContentLoaded', function() {
    const counters = document.querySelectorAll('.counter');
    
    counters.forEach(counter => {
        const target = parseInt(counter.getAttribute('data-target'));
        const increment = target / 100;
        let current = 0;
        
        const updateCounter = () => {
            if (current < target) {
                current += increment;
                counter.textContent = Math.ceil(current);
                setTimeout(updateCounter, 20);
            } else {
                counter.textContent = target;
            }
        };
        
        updateCounter();
    });
});

// Biểu đồ xu hướng thời gian
const timelineCtx = document.getElementById('timelineChart').getContext('2d');
const timelineChart = new Chart(timelineCtx, {
    type: 'line',
    data: {
        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
        datasets: [{
            label: 'Dự án mới',
            data: [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Dự án hoàn thành',
            data: [8, 15, 12, 20, 18, 25, 23, 30, 28, 35, 33, 40],
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        },
        elements: {
            point: {
                radius: 4,
                hoverRadius: 6
            }
        }
    }
});

// Biểu đồ trạng thái dự án
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Đang thực hiện', 'Hoàn thành', 'Tạm dừng', 'Hủy bỏ'],
        datasets: [{
            data: [{{ active_projects }}, {{ completed_projects }}, {{ paused_projects }}, {{ cancelled_projects }}],
            backgroundColor: [
                'rgba(40, 167, 69, 0.8)',
                'rgba(0, 123, 255, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(220, 53, 69, 0.8)'
            ],
            borderColor: [
                'rgba(40, 167, 69, 1)',
                'rgba(0, 123, 255, 1)',
                'rgba(255, 193, 7, 1)',
                'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Biểu đồ công ty (cải tiến)
const companyCtx = document.getElementById('companyChart').getContext('2d');
const companyChart = new Chart(companyCtx, {
    type: 'bar',
    data: {
        labels: [{% for company in company_stats %}'{{ company.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Số dự án',
            data: [{% for company in company_stats %}{{ company.project_count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 2,
            borderRadius: 5
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Biểu đồ thiết bị (cải tiến)
const equipmentCtx = document.getElementById('equipmentChart').getContext('2d');
const equipmentChart = new Chart(equipmentCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for equipment in equipment_usage %}'{{ equipment.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for equipment in equipment_usage %}{{ equipment.usage_count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Biểu đồ phương pháp NDT
const methodCtx = document.getElementById('methodChart').getContext('2d');
const methodChart = new Chart(methodCtx, {
    type: 'polarArea',
    data: {
        labels: ['Siêu âm', 'Từ tính', 'Xuyên thấu', 'Phóng xạ', 'Dòng xoáy'],
        datasets: [{
            data: [30, 25, 20, 15, 10],
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 205, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Biểu đồ phân bố khu vực
const locationCtx = document.getElementById('locationChart').getContext('2d');
const locationChart = new Chart(locationCtx, {
    type: 'radar',
    data: {
        labels: ['Hà Nội', 'TP.HCM', 'Đà Nẵng', 'Hải Phòng', 'Cần Thơ', 'Vũng Tàu'],
        datasets: [{
            label: 'Số dự án',
            data: [65, 59, 90, 81, 56, 55],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            r: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        }
    }
});

// Hàm cập nhật biểu đồ timeline
function updateTimeChart(period) {
    // Cập nhật active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Cập nhật dữ liệu biểu đồ dựa trên period
    // Đây là ví dụ, bạn có thể tích hợp với API để lấy dữ liệu thực
    let newLabels, newData1, newData2;
    
    if (period === 'month') {
        newLabels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
        newData1 = [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45];
        newData2 = [8, 15, 12, 20, 18, 25, 23, 30, 28, 35, 33, 40];
    } else if (period === 'quarter') {
        newLabels = ['Q1', 'Q2', 'Q3', 'Q4'];
        newData1 = [46, 77, 95, 123];
        newData2 = [35, 63, 81, 108];
    } else {
        newLabels = ['2020', '2021', '2022', '2023', '2024'];
        newData1 = [120, 180, 250, 341, 420];
        newData2 = [95, 150, 210, 287, 350];
    }
    
    timelineChart.data.labels = newLabels;
    timelineChart.data.datasets[0].data = newData1;
    timelineChart.data.datasets[1].data = newData2;
    timelineChart.update();
}
</script>
{% endblock %}

<!-- CSS cho animation và hiệu ứng -->
<style>
.hover-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.report-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.report-card:hover {
    transform: translateY(-3px);
    border-color: currentColor;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.counter {
    font-weight: bold;
    font-size: 2rem;
}

@keyframes countUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    border: none;
    border-radius: 10px;
}

.progress {
    border-radius: 10px;
}

.table th {
    border-top: none;
    font-weight: 600;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Animation cho số đếm
document.addEventListener('DOMContentLoaded', function() {
    const counters = document.querySelectorAll('.counter');
    
    counters.forEach(counter => {
        const target = parseInt(counter.getAttribute('data-target'));
        const increment = target / 100;
        let current = 0;
        
        const updateCounter = () => {
            if (current < target) {
                current += increment;
                counter.textContent = Math.ceil(current);
                setTimeout(updateCounter, 20);
            } else {
                counter.textContent = target;
            }
        };
        
        updateCounter();
    });
});

// Biểu đồ xu hướng thời gian
const timelineCtx = document.getElementById('timelineChart').getContext('2d');
const timelineChart = new Chart(timelineCtx, {
    type: 'line',
    data: {
        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
        datasets: [{
            label: 'Dự án mới',
            data: [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Dự án hoàn thành',
            data: [8, 15, 12, 20, 18, 25, 23, 30, 28, 35, 33, 40],
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        },
        elements: {
            point: {
                radius: 4,
                hoverRadius: 6
            }
        }
    }
});

// Biểu đồ trạng thái dự án
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Đang thực hiện', 'Hoàn thành', 'Tạm dừng', 'Hủy bỏ'],
        datasets: [{
            data: [{{ active_projects }}, {{ completed_projects }}, {{ paused_projects }}, {{ cancelled_projects }}],
            backgroundColor: [
                'rgba(40, 167, 69, 0.8)',
                'rgba(0, 123, 255, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(220, 53, 69, 0.8)'
            ],
            borderColor: [
                'rgba(40, 167, 69, 1)',
                'rgba(0, 123, 255, 1)',
                'rgba(255, 193, 7, 1)',
                'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Biểu đồ công ty (cải tiến)
const companyCtx = document.getElementById('companyChart').getContext('2d');
const companyChart = new Chart(companyCtx, {
    type: 'bar',
    data: {
        labels: [{% for company in company_stats %}'{{ company.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Số dự án',
            data: [{% for company in company_stats %}{{ company.project_count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 2,
            borderRadius: 5
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Biểu đồ thiết bị (cải tiến)
const equipmentCtx = document.getElementById('equipmentChart').getContext('2d');
const equipmentChart = new Chart(equipmentCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for equipment in equipment_usage %}'{{ equipment.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for equipment in equipment_usage %}{{ equipment.usage_count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Biểu đồ phương pháp NDT
const methodCtx = document.getElementById('methodChart').getContext('2d');
const methodChart = new Chart(methodCtx, {
    type: 'polarArea',
    data: {
        labels: ['Siêu âm', 'Từ tính', 'Xuyên thấu', 'Phóng xạ', 'Dòng xoáy'],
        datasets: [{
            data: [30, 25, 20, 15, 10],
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 205, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Biểu đồ phân bố khu vực
const locationCtx = document.getElementById('locationChart').getContext('2d');
const locationChart = new Chart(locationCtx, {
    type: 'radar',
    data: {
        labels: ['Hà Nội', 'TP.HCM', 'Đà Nẵng', 'Hải Phòng', 'Cần Thơ', 'Vũng Tàu'],
        datasets: [{
            label: 'Số dự án',
            data: [65, 59, 90, 81, 56, 55],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            r: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        }
    }
});

// Hàm cập nhật biểu đồ timeline
function updateTimeChart(period) {
    // Cập nhật active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Cập nhật dữ liệu biểu đồ dựa trên period
    // Đây là ví dụ, bạn có thể tích hợp với API để lấy dữ liệu thực
    let newLabels, newData1, newData2;
    
    if (period === 'month') {
        newLabels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
        newData1 = [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45];
        newData2 = [8, 15, 12, 20, 18, 25, 23, 30, 28, 35, 33, 40];
    } else if (period === 'quarter') {
        newLabels = ['Q1', 'Q2', 'Q3', 'Q4'];
        newData1 = [46, 77, 95, 123];
        newData2 = [35, 63, 81, 108];
    } else {
        newLabels = ['2020', '2021', '2022', '2023', '2024'];
        newData1 = [120, 180, 250, 341, 420];
        newData2 = [95, 150, 210, 287, 350];
    }
    
    timelineChart.data.labels = newLabels;
    timelineChart.data.datasets[0].data = newData1;
    timelineChart.data.datasets[1].data = newData2;
    timelineChart.update();
}
</script>
{% endblock %}

<!-- CSS cho animation và hiệu ứng -->
<style>
.hover-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.report-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.report-card:hover {
    transform: translateY(-3px);
    border-color: currentColor;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.counter {
    font-weight: bold;
    font-size: 2rem;
}

@keyframes countUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    border: none;
    border-radius: 10px;
}

.progress {
    border-radius: 10px;
}

.table th {
    border-top: none;
    font-weight: 600;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Animation cho số đếm
document.addEventListener('DOMContentLoaded', function() {
    const counters = document.querySelectorAll('.counter');
    
    counters.forEach(counter => {
        const target = parseInt(counter.getAttribute('data-target'));
        const increment = target / 100;
        let current = 0;
        
        const updateCounter = () => {
            if (current < target) {
                current += increment;
                counter.textContent = Math.ceil(current);
                setTimeout(updateCounter, 20);
            } else {
                counter.textContent = target;
            }
        };
        
        updateCounter();
    });
});

// Biểu đồ xu hướng thời gian
const timelineCtx = document.getElementById('timelineChart').getContext('2d');
const timelineChart = new Chart(timelineCtx, {
    type: 'line',
    data: {
        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
        datasets: [{
            label: 'Dự án mới',
            data: [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Dự án hoàn thành',
            data: [8, 15, 12, 20, 18, 25, 23, 30, 28, 35, 33, 40],
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        },
        elements: {
            point: {
                radius: 4,
                hoverRadius: 6
            }
        }
    }
});

// Biểu đồ trạng thái dự án
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Đang thực hiện', 'Hoàn thành', 'Tạm dừng', 'Hủy bỏ'],
        datasets: [{
            data: [{{ active_projects }}, {{ completed_projects }}, {{ paused_projects }}, {{ cancelled_projects }}],
            backgroundColor: [
                'rgba(40, 167, 69, 0.8)',
                'rgba(0, 123, 255, 0.8)',
                'rgba(255, 193, 7, 0.8)',
                'rgba(220, 53, 69, 0.8)'
            ],
            borderColor: [
                'rgba(40, 167, 69, 1)',
                'rgba(0, 123, 255, 1)',
                'rgba(255, 193, 7, 1)',
                'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Biểu đồ công ty (cải tiến)
const companyCtx = document.getElementById('companyChart').getContext('2d');
const companyChart = new Chart(companyCtx, {
    type: 'bar',
    data: {
        labels: [{% for company in company_stats %}'{{ company.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Số dự án',
            data: [{% for company in company_stats %}{{ company.project_count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 2,
            borderRadius: 5
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Biểu đồ thiết bị (cải tiến)
const equipmentCtx = document.getElementById('equipmentChart').getContext('2d');
const equipmentChart = new Chart(equipmentCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for equipment in equipment_usage %}'{{ equipment.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for equipment in equipment_usage %}{{ equipment.usage_count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Biểu đồ phương pháp NDT
const methodCtx = document.getElementById('methodChart').getContext('2d');
const methodChart = new Chart(methodCtx, {
    type: 'polarArea',
    data: {
        labels: ['Siêu âm', 'Từ tính', 'Xuyên thấu', 'Phóng xạ', 'Dòng xoáy'],
        datasets: [{
            data: [30, 25, 20, 15, 10],
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 205, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Biểu đồ phân bố khu vực
const locationCtx = document.getElementById('locationChart').getContext('2d');
const locationChart = new Chart(locationCtx, {
    type: 'radar',
    data: {
        labels: ['Hà Nội', 'TP.HCM', 'Đà Nẵng', 'Hải Phòng', 'Cần Thơ', 'Vũng Tàu'],
        datasets: [{
            label: 'Số dự án',
            data: [65, 59, 90, 81, 56, 55],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            r: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        }
    }
});

// Hàm cập nhật biểu đồ timeline
function updateTimeChart(period) {
    // Cập nhật active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Cập nhật dữ liệu biểu đồ dựa trên period
    // Đây là ví dụ, bạn có thể tích hợp với API để lấy dữ liệu thực
    let newLabels, newData1, newData2;
    
    if (period === 'month') {
        newLabels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
        newData1 = [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45];
        newData2 = [8, 15, 12, 20, 18, 25, 23, 30, 28, 35, 33, 40];
    } else if (period === 'quarter') {
        newLabels = ['Q1', 'Q2', 'Q3', 'Q4'];
        newData1 = [46, 77, 95, 123];
        newData2 = [35, 63, 81, 108];
    } else {
        newLabels = ['2020', '2021', '2022', '2023', '2024'];
        newData1 = [120, 180, 250, 341, 420];
        newData2 = [95, 150, 210, 287, 350];
    }
    
    timelineChart.data.labels = newLabels;
    timelineChart.data.datasets[0].data = newData1;
    timelineChart.data.datasets[1].data = newData2;
    timelineChart.update();
}
</script>
{% endblock %}

<!-- CSS cho animation và hiệu ứng -->
<style>
.hover-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.report-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.report-card:hover {
    transform: translateY(-3px);
    border-color: currentColor;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.counter {
    font-weight: bold;
    font-size: 2rem;
}

@keyframes countUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    border: none;
    border-radius: 10px;
}

.progress {
    border-radius: 10px;
}

.table th {
    border-top: none;
    font-weight: 600;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Animation cho số đếm
document.addEventListener('DOMContentLoaded', function() {
    const counters = document.querySelectorAll('.counter');
    
    counters.forEach(counter => {
        const target = parseInt(counter.getAttribute('data-target'));
        const increment = target / 100;
        let current = 0;
        
        const updateCounter = () => {
            if (current < target) {
                current += increment;
                counter.textContent = Math.ceil(current);
                setTimeout(updateCounter, 20);
            } else {
                counter.textContent = target;
            }
        };
        
        updateCounter();
    });
});

// Biểu đồ xu hướng thời gian
const timelineCtx = document.getElementById('timelineChart').getContext('2d');
const timelineChart = new Chart(timelineCtx, {
    type: 'line',
    data: {
        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
        datasets: [{
            label: 'Dự án mới',
            data: [12, 19, 15, 25, 22, 30, 28, 35, 32, 40, 38, 45],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Dự án hoàn thành',
            data: [8, 15, 12, 20, 18, 25, 23, 30, 28, 35, 33, 40],
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        },
        elements: {
            point: {
                radius: 4,
                hoverRadius: 6
            }
        }
    }
});

// Biểu đồ trạng thái dự án
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Đang thực hiện', 'Hoàn thành', 'Tạm dừng', 'Hủy bỏ