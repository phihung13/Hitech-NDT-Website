{% extends "admin/change_form.html" %}
{% load static %}

{% block admin_change_form_document_ready %}
{{ block.super }}

<!-- SEO Analyzer Styles -->
<style>
/* Fix Django Admin wide form indentation */
.form-row.wide p,
.form-row.wide ul.errorlist,
.form-row.wide input + p.help,
.form-row.wide input + div.help,
.form-row.wide textarea + p.help,
.form-row.wide textarea + div.help,
.form-row.wide .cke + p.help,
.form-row.wide .cke + div.help {
    margin-left: 0 !important;
}

.form-row.wide .field-content,
.form-row.wide .field-content .cke {
    margin-left: 0 !important;
}

/* CKEditor container fix */
.django-ckeditor-widget {
    margin-left: 0 !important;
}

/* Override Django admin wide class margin */
form .wide p,
form .wide ul.errorlist,
form .wide input + p.help,
form .wide input + div.help,
form .wide textarea + p.help,
form .wide textarea + div.help,
form .wide select + p.help,
form .wide select + div.help {
    margin-left: 0 !important;
}

/* Fix for CKEditor5 specifically */
.field-content .django-ckeditor-5 {
    margin-left: 0 !important;
}

.field-content {
    margin-left: 0 !important;
}

/* Fix CKEditor text color - make it darker/black */
.ck-editor__editable {
    color: #333 !important;
}

.ck-content {
    color: #333 !important;
}

.ck-content p {
    color: #333 !important;
}

/* Fix CKEditor placeholder text */
.ck-editor__editable.ck-placeholder::before {
    color: #999 !important;
}

/* Ensure text is readable in all states */
.ck-editor__editable:not(.ck-focused) {
    color: #333 !important;
}

.ck-editor__editable.ck-focused {
    color: #000 !important;
}

.seo-analyzer-container {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    position: sticky;
    top: 20px;
    z-index: 100;
}

.seo-score-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    transition: all 0.3s ease;
}

.seo-score-excellent { background: linear-gradient(135deg, #28a745, #20c997); }
.seo-score-good { background: linear-gradient(135deg, #ffc107, #fd7e14); }
.seo-score-poor { background: linear-gradient(135deg, #dc3545, #e83e8c); }

.seo-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.seo-detail-card {
    background: white;
    border-radius: 6px;
    padding: 15px;
    border-left: 4px solid #007cba;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.seo-detail-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.seo-detail-score {
    font-size: 1.1rem;
    font-weight: bold;
    color: #007cba;
    margin-bottom: 8px;
}

.seo-strengths, .seo-issues {
    font-size: 0.85rem;
    line-height: 1.4;
}

.seo-strengths { color: #28a745; }
.seo-issues { color: #dc3545; }

.seo-suggestions {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 15px;
    margin-top: 15px;
}

.seo-suggestions h4 {
    color: #856404;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 10px;
}

.seo-suggestions ul {
    margin: 0;
    padding-left: 20px;
    font-size: 0.85rem;
    color: #856404;
}

.google-preview {
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 15px;
    margin: 15px 0;
    font-family: arial, sans-serif;
}

.google-preview-url {
    color: #202124;
    font-size: 14px;
    margin-bottom: 3px;
}

.google-preview-title {
    color: #1a0dab;
    font-size: 20px;
    line-height: 1.3;
    text-decoration: none;
    margin-bottom: 3px;
    display: block;
}

.google-preview-title:hover {
    text-decoration: underline;
}

.google-preview-description {
    color: #4d5156;
    font-size: 14px;
    line-height: 1.4;
}

.char-counter {
    font-size: 0.8rem;
    margin-top: 5px;
    font-weight: 500;
}

.char-counter.good { color: #28a745; }
.char-counter.warning { color: #ffc107; }
.char-counter.danger { color: #dc3545; }

.seo-loading {
    text-align: center;
    padding: 20px;
    color: #6c757d;
}

.seo-analyze-btn {
    background: linear-gradient(135deg, #007cba, #0056b3);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    margin-bottom: 15px;
}

.seo-analyze-btn:hover {
    background: linear-gradient(135deg, #0056b3, #004085);
}

.seo-analyze-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#seo-reset-btn:hover {
    background: linear-gradient(135deg, #495057, #343a40) !important;
}

.seo-btn-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
</style>

<!-- SEO Analyzer HTML -->
<div class="seo-analyzer-container">
    <h3 style="margin-bottom: 15px; color: #333;">
        üîç Ph√¢n t√≠ch SEO Real-time
    </h3>
    
    <div class="seo-btn-container">
        <button type="button" id="seo-analyze-btn" class="seo-analyze-btn">
            üìä Ph√¢n t√≠ch SEO
        </button>
        <button type="button" id="seo-reset-btn" class="seo-analyze-btn" style="background: linear-gradient(135deg, #6c757d, #495057);">
            üîÑ Reset & T√≠nh l·∫°i
        </button>
    </div>
    
    <div id="seo-results" style="display: none;">
        <!-- Score Circle -->
        <div style="text-align: center;">
            <div id="seo-score-circle" class="seo-score-circle">
                <div id="seo-score-number">0</div>
            </div>
            <h4 id="seo-score-text">ƒêi·ªÉm SEO: 0/100</h4>
        </div>
        
        <!-- Google Preview -->
        <div class="google-preview">
            <div class="google-preview-url" id="google-preview-url">
                https://hitechndt.vn/blog/slug-here/
            </div>
            <a href="#" class="google-preview-title" id="google-preview-title">
                Ti√™u ƒë·ªÅ b√†i vi·∫øt s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y
            </a>
            <div class="google-preview-description" id="google-preview-description">
                M√¥ t·∫£ b√†i vi·∫øt s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y tr√™n Google Search khi ng∆∞·ªùi d√πng t√¨m ki·∫øm...
            </div>
        </div>
        
        <!-- SEO Details -->
        <div id="seo-details" class="seo-details">
            <!-- S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
        </div>
        
        <!-- Suggestions -->
        <div id="seo-suggestions" class="seo-suggestions" style="display: none;">
            <h4>üí° G·ª£i √Ω c·∫£i thi·ªán:</h4>
            <ul id="seo-suggestions-list">
                <!-- S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
            </ul>
        </div>
    </div>
    
    <div id="seo-loading" class="seo-loading" style="display: none;">
        <div>üîÑ ƒêang ph√¢n t√≠ch SEO...</div>
    </div>
</div>

<!-- JavaScript for SEO Analyzer -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analyzeBtn = document.getElementById('seo-analyze-btn');
    const resetBtn = document.getElementById('seo-reset-btn');
    const loadingDiv = document.getElementById('seo-loading');
    const resultsDiv = document.getElementById('seo-results');
    
    // Character counters
    const metaTitleField = document.getElementById('id_meta_title');
    const metaDescField = document.getElementById('id_meta_description');
    const titleField = document.getElementById('id_title');
    
    // Add character counters
    if (metaTitleField) {
        addCharCounter(metaTitleField, 60, 'Meta Title');
    }
    if (metaDescField) {
        addCharCounter(metaDescField, 160, 'Meta Description');
    }
    
    // Auto-update Google preview
    if (titleField) titleField.addEventListener('input', updateGooglePreview);
    if (metaTitleField) metaTitleField.addEventListener('input', updateGooglePreview);
    if (metaDescField) metaDescField.addEventListener('input', updateGooglePreview);
    
    // SEO Analysis button
    analyzeBtn.addEventListener('click', performSEOAnalysis);
    
    // Reset SEO button
    resetBtn.addEventListener('click', function() {
        resetBtn.disabled = true;
        resetBtn.textContent = 'üîÑ ƒêang reset...';
        
        // Reset form
        resetSEOResults();
        
        // Auto-perform analysis after reset
        setTimeout(() => {
            performSEOAnalysis();
            resetBtn.disabled = false;
            resetBtn.textContent = 'üîÑ Reset & T√≠nh l·∫°i';
        }, 500);
    });
    
    function addCharCounter(field, maxLength, label) {
        const counter = document.createElement('div');
        counter.className = 'char-counter';
        field.parentNode.appendChild(counter);
        
        function updateCounter() {
            const length = field.value.length;
            counter.textContent = `${length}/${maxLength} k√Ω t·ª±`;
            
            if (length === 0) {
                counter.className = 'char-counter';
            } else if (length <= maxLength * 0.8) {
                counter.className = 'char-counter good';
            } else if (length <= maxLength) {
                counter.className = 'char-counter warning';
            } else {
                counter.className = 'char-counter danger';
            }
        }
        
        field.addEventListener('input', updateCounter);
        updateCounter();
    }
    
    function updateGooglePreview() {
        const title = metaTitleField?.value || titleField?.value || 'Ti√™u ƒë·ªÅ b√†i vi·∫øt';
        const description = metaDescField?.value || 'M√¥ t·∫£ b√†i vi·∫øt s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...';
        const slug = document.getElementById('id_slug')?.value || 'slug-here';
        
        document.getElementById('google-preview-title').textContent = title;
        document.getElementById('google-preview-description').textContent = description;
        document.getElementById('google-preview-url').textContent = `https://hitechndt.vn/blog/${slug}/`;
    }
    
    function resetSEOResults() {
        // Reset score circle
        const scoreCircle = document.getElementById('seo-score-circle');
        const scoreNumber = document.getElementById('seo-score-number');
        const scoreText = document.getElementById('seo-score-text');
        
        scoreNumber.textContent = '0';
        scoreText.textContent = 'ƒêi·ªÉm SEO: 0/100';
        scoreCircle.className = 'seo-score-circle seo-score-poor';
        
        // Clear details
        document.getElementById('seo-details').innerHTML = '';
        
        // Hide suggestions
        document.getElementById('seo-suggestions').style.display = 'none';
        
        // Hide results
        resultsDiv.style.display = 'none';
        
        // Update Google preview with current values
        updateGooglePreview();
        
        console.log('üîÑ SEO results reset');
    }
    
    function performSEOAnalysis() {
        const title = titleField?.value || '';
        const metaTitle = metaTitleField?.value || '';
        const metaDescription = metaDescField?.value || '';
        const keywords = document.getElementById('id_meta_keywords')?.value || '';
        const slug = document.getElementById('id_slug')?.value || '';
        
        // Get content from CKEditor if available
        let content = '';
        if (window.CKEDITOR && CKEDITOR.instances.id_content) {
            content = CKEDITOR.instances.id_content.getData();
        } else {
            const contentField = document.getElementById('id_content');
            content = contentField?.value || '';
        }
        
        if (!title || !content) {
            alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ v√† n·ªôi dung tr∆∞·ªõc khi ph√¢n t√≠ch SEO!');
            return;
        }
        
        // Show loading
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'üîÑ ƒêang ph√¢n t√≠ch...';
        loadingDiv.style.display = 'block';
        resultsDiv.style.display = 'none';
        
        // Prepare data
        const data = {
            title: title,
            meta_title: metaTitle,
            meta_description: metaDescription,
            content: content,
            meta_keywords: keywords,
            slug: slug
        };
        
        // Send AJAX request
        fetch('/admin/api/post/seo-analysis/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySEOResults(data.analysis);
            } else {
                alert('L·ªói ph√¢n t√≠ch SEO: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i!');
        })
        .finally(() => {
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'üìä Ph√¢n t√≠ch SEO';
            loadingDiv.style.display = 'none';
        });
    }
    
    function displaySEOResults(analysis) {
        const score = analysis.percentage || 0;
        const totalScore = analysis.total_score || 0;
        const maxScore = analysis.max_total_score || 15;
        const scoreCircle = document.getElementById('seo-score-circle');
        const scoreNumber = document.getElementById('seo-score-number');
        const scoreText = document.getElementById('seo-score-text');
        
        // Update score
        scoreNumber.textContent = score;
        scoreText.textContent = `ƒêi·ªÉm SEO: ${score}/100 (${totalScore}/${maxScore})`;
        
        // Update score circle color
        scoreCircle.className = 'seo-score-circle';
        if (score >= 80) {
            scoreCircle.classList.add('seo-score-excellent');
        } else if (score >= 60) {
            scoreCircle.classList.add('seo-score-good');
        } else {
            scoreCircle.classList.add('seo-score-poor');
        }
        
        // Update details
        const detailsContainer = document.getElementById('seo-details');
        detailsContainer.innerHTML = '';
        
        for (const [section, details] of Object.entries(analysis.details)) {
            const card = document.createElement('div');
            card.className = 'seo-detail-card';
            
            let strengthsHTML = '';
            let issuesHTML = '';
            
            if (details.strengths && details.strengths.length > 0) {
                strengthsHTML = `
                    <div class="seo-strengths">
                        <strong>‚úÖ ƒêi·ªÉm m·∫°nh:</strong><br>
                        ${details.strengths.map(s => `‚Ä¢ ${s}`).join('<br>')}
                    </div>
                `;
            }
            
            if (details.issues && details.issues.length > 0) {
                issuesHTML = `
                    <div class="seo-issues">
                        <strong>‚ùå C·∫ßn c·∫£i thi·ªán:</strong><br>
                        ${details.issues.map(i => `‚Ä¢ ${i}`).join('<br>')}
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="seo-detail-title">${getSectionTitle(section)}</div>
                <div class="seo-detail-score">${details.score}/${details.max_score}</div>
                ${strengthsHTML}
                ${issuesHTML}
            `;
            
            detailsContainer.appendChild(card);
        }
        
        // Update suggestions
        if (analysis.suggestions && analysis.suggestions.length > 0) {
            const suggestionsContainer = document.getElementById('seo-suggestions');
            const suggestionsList = document.getElementById('seo-suggestions-list');
            
            suggestionsList.innerHTML = '';
            analysis.suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.textContent = suggestion;
                suggestionsList.appendChild(li);
            });
            
            suggestionsContainer.style.display = 'block';
        }
        
        resultsDiv.style.display = 'block';
    }
    
    function getSectionTitle(section) {
        const titles = {
            'title': 'üìù Ti√™u ƒë·ªÅ',
            'meta_description': 'üìÑ Meta Description',
            'content': 'üìñ N·ªôi dung',
            'images': 'üñºÔ∏è H√¨nh ·∫£nh',
            'technical': '‚öôÔ∏è K·ªπ thu·∫≠t'
        };
        return titles[section] || section;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Initial Google preview update
    updateGooglePreview();
});
</script>
{% endblock %} 